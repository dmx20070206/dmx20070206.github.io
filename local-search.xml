<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Rust</title>
    <link href="/2024/11/24/Rust/"/>
    <url>/2024/11/24/Rust/</url>
    
    <content type="html"><![CDATA[<h2 id="Chapter2"><a href="#Chapter2" class="headerlink" title="Chapter2"></a>Chapter2</h2><p>let å®šä¹‰å˜é‡ï¼Œé»˜è®¤ä¸å¯å˜ï¼Œå¯å˜å˜é‡éœ€è¦ç”¨ mut å…³é”®å­—ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">num</span> = <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><p>å¼ºç±»å‹æ¨å¯¼ï¼Œä¼šæ ¹æ®ç­‰å·å³è¾¹ç»“æœæˆ–è€…åæ–‡è‡ªåŠ¨æ¨å¯¼å˜é‡ç±»å‹ã€‚ä½¿ç”¨å†’å·å¯ä»¥å®šä¹‰ç±»å‹ã€‚Rust åœ¨ç¼–è¯‘çš„æ—¶å€™å°±å¿…é¡»çŸ¥é“å˜é‡çš„ç±»å‹ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">num</span>: <span class="hljs-type">i32</span> = <span class="hljs-number">10</span>;<br><span class="hljs-keyword">let</span> <span class="hljs-variable">num</span>: <span class="hljs-type">u32</span> = <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><p>å®<code>println!</code>ç”¨äºè¾“å‡ºï¼Œ<code>&#123;&#125;</code>ç”¨äºå¡«å…¥æ­¤å‚æ•°ï¼Œåœ¨å¤§æ‹¬å·ä¸­å¡«æ•°å­—å¯ä»¥åˆ†ç»„ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;cout &#123;0&#125;, &#123;0&#125;, &#123;1&#125;&quot;</span>, a, b);<br></code></pre></td></tr></table></figure><p>æœ‰äº›å‡½æ•°çš„è¿”å›å€¼ä¸º<code>Rusult</code>ï¼Œæœ‰<code>Ok</code>, <code>Err</code>ä¸¤ç§ï¼Œä½¿ç”¨<code>expect</code>å‡½æ•°å¯ä»¥åœ¨é”™è¯¯æ—¶è¾“å‡ºä¿¡æ¯ï¼Œä½†æ˜¯ç¨‹åºä»ç„¶ä¼šå´©æºƒã€‚ä½¿ç”¨<code>match</code>å¯ä»¥ä¼˜ç¾(ç½‘ä¸Šè¿™ä¹ˆè¯´çš„)çš„åœ¨é”™è¯¯æ—¶é‡‡å–å…¶ä»–çš„è¡Œä¸ºä»è€Œä½¿ç¨‹åºç»§ç»­ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-comment">// expect</span><br>io::<span class="hljs-title function_ invoke__">stdin</span>().<span class="hljs-title function_ invoke__">read_line</span>(&amp;<span class="hljs-keyword">mut</span> num).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;Failed to read line&quot;</span>);<br><br><span class="hljs-comment">// match</span><br><span class="hljs-keyword">match</span> io::<span class="hljs-title function_ invoke__">stdin</span>().<span class="hljs-title function_ invoke__">read_line</span>(&amp;<span class="hljs-keyword">mut</span> num) &#123;<br>  <span class="hljs-title function_ invoke__">Ok</span>(num) =&gt; num,<br>  <span class="hljs-title function_ invoke__">Err</span>(_) =&gt; ...,    <span class="hljs-comment">// _ = not care</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>çŒœæ•°æ¸¸æˆï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-keyword">use</span> rand::Rng;<br><span class="hljs-keyword">use</span> std::cmp::Ordering;<br><span class="hljs-keyword">use</span> std::io;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">secret_number</span> = rand::<span class="hljs-title function_ invoke__">thread_rng</span>().<span class="hljs-title function_ invoke__">gen_range</span>(<span class="hljs-number">1</span>..=<span class="hljs-number">100</span>);<br><br>    <span class="hljs-keyword">loop</span> &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Please input your guess.&quot;</span>);<br><br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">guess</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>();<br><br>        io::<span class="hljs-title function_ invoke__">stdin</span>().<span class="hljs-title function_ invoke__">read_line</span>(&amp;<span class="hljs-keyword">mut</span> guess).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;Failed to read line&quot;</span>);<br><br>        <span class="hljs-comment">// shadow</span><br>        <span class="hljs-comment">// trim : delete &quot; &quot;</span><br>        <span class="hljs-comment">// parse : stoi</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">guess</span>: <span class="hljs-type">u32</span> = <span class="hljs-keyword">match</span> guess.<span class="hljs-title function_ invoke__">trim</span>().<span class="hljs-title function_ invoke__">parse</span>() &#123;<br>            <span class="hljs-title function_ invoke__">Ok</span>(num) =&gt; num,<br>            <span class="hljs-title function_ invoke__">Err</span>(_) =&gt; <span class="hljs-keyword">continue</span>,     <span class="hljs-comment">// _ = not care</span><br>        &#125;;<br><br>        <span class="hljs-keyword">match</span> guess.<span class="hljs-title function_ invoke__">cmp</span>(&amp;secret_number) &#123;<br>            Ordering::Less =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Too small!&quot;</span>),<br>            Ordering::Greater =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Too big!&quot;</span>),<br>            Ordering::Equal =&gt; &#123;<br>                <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;You win!&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Chapter3"><a href="#Chapter3" class="headerlink" title="Chapter3"></a>Chapter3</h2><p>å¸¸é‡ä¸ç­‰äºä¸å¯å˜çš„å˜é‡ï¼Œconst å£°æ˜ï¼Œå¿…é¡»æŒ‡å®šç±»å‹ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-keyword">const</span> MAX_NUM: <span class="hljs-type">i64</span> = <span class="hljs-number">20070206</span>;<br></code></pre></td></tr></table></figure><p>Shadow æœºåˆ¶ï¼ŒåŒåå˜é‡åè€…ä¼šéšè—å‰è€…ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-comment">// mut</span><br><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">num1</span> = <span class="hljs-number">10</span>;<br>num1 = <span class="hljs-number">20</span>;<br><br><span class="hljs-comment">// shadow</span><br><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">num1</span> = <span class="hljs-number">10</span>;<br><span class="hljs-keyword">let</span> <span class="hljs-variable">num1</span> = <span class="hljs-string">&quot;dmx20070206&quot;</span>;<br></code></pre></td></tr></table></figure><p>Rust çš„æ•´æ•°ç±»å‹ï¼š</p><table><thead><tr><th>ä½é•¿åº¦</th><th>æœ‰ç¬¦å·</th><th>æ— ç¬¦å·</th></tr></thead><tbody><tr><td>8 bit</td><td>i8</td><td>u8</td></tr><tr><td>16 bit</td><td>i16</td><td>u16</td></tr><tr><td>32 bit</td><td>i32</td><td>u32</td></tr><tr><td>64 bit</td><td>i64</td><td>u64</td></tr><tr><td>128 bit</td><td>i128</td><td>u128</td></tr><tr><td>arch</td><td>isize</td><td>usize</td></tr><tr><td>ä¸åŒè¿›åˆ¶ï¼š0x, 0o, 0bã€‚ä»»ä½•è¿›åˆ¶éƒ½å¯ä»¥ç”¨ _ åˆ†å‰²ã€‚i32 ä¸ºé»˜è®¤ç±»å‹ã€‚</td><td></td><td></td></tr></tbody></table><p>Rust çš„æµ®ç‚¹æ•°ç±»å‹ï¼š<br>f32, f64, IEEE-754 æ ‡å‡†ã€‚f64 ä¸ºé»˜è®¤ç±»å‹ã€‚</p><p>Rust çš„å¸ƒå°”ç±»å‹ï¼šç•¥</p><p>Rust çš„å­—ç¬¦ç±»å‹ï¼š<br>è¡¨ç¤ºä¸€ä¸ª Unicode å­—ç¬¦ï¼Œå ç”¨ 4 ä¸ªå­—èŠ‚ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">num1</span> = &#x27;ğŸ˜…&#x27;;<br></code></pre></td></tr></table></figure><p>Rust ä¸­çš„ Tupleï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">num</span>: (<span class="hljs-type">u32</span>, <span class="hljs-type">char</span>, <span class="hljs-type">f32</span>) = (<span class="hljs-number">10</span>, &#x27;ğŸ˜…&#x27;, <span class="hljs-number">1.5</span>);<br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>, num.<span class="hljs-number">0</span>, num.<span class="hljs-number">1</span>, num.<span class="hljs-number">2</span>);<br></code></pre></td></tr></table></figure><p>Rust ä¸­çš„ æ•°ç»„:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-comment">// ç±»å‹; é•¿åº¦</span><br><span class="hljs-keyword">let</span> <span class="hljs-variable">num</span>: [<span class="hljs-type">f64</span>; <span class="hljs-number">3</span>] = [<span class="hljs-number">1.1</span>, <span class="hljs-number">1.2</span>, <span class="hljs-number">1.3</span>];<br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>, num[<span class="hljs-number">0</span>], num[<span class="hljs-number">1</span>], num[<span class="hljs-number">2</span>]);<br><br><span class="hljs-comment">// æ•°æ®; é‡å¤æ¬¡æ•°</span><br><span class="hljs-keyword">let</span> <span class="hljs-variable">num</span> = [<span class="hljs-number">3</span>; <span class="hljs-number">5</span>];<br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>, num[<span class="hljs-number">0</span>], num[<span class="hljs-number">1</span>], num[<span class="hljs-number">2</span>], num[<span class="hljs-number">3</span>], num[<span class="hljs-number">4</span>]);<br></code></pre></td></tr></table></figure><p>Rust ä¸­çš„è¡¨è¾¾å¼ç±»å‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-comment">// x = the last expression</span><br><span class="hljs-keyword">let</span> <span class="hljs-variable">x</span> = &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">num</span> = <span class="hljs-number">10</span>;<br>        num<br>    &#125;;<br></code></pre></td></tr></table></figure><p>Rust ä¸­çš„å‡½æ•°ï¼Œç”¨<code>fn</code>å…³é”®å­—ï¼Œå‚æ•°å¿…é¡»å£°æ˜ç±»å‹ï¼Œè¿”å›å€¼ç”¨<code>-&gt;</code>ç¬¦å·å®šä¹‰ï¼Œå‡½æ•°é»˜è®¤è¿”å›æœ€åä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå¯ä»¥éšè—<code>return</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-comment">// return the last expression</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">function</span>(x: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u32</span> &#123;<br>    x + <span class="hljs-number">1</span><br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">function</span>(x: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u32</span> &#123;<br>    <span class="hljs-keyword">return</span> x + <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>Rust ä¸­çš„ if-elseï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">condition</span> = <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">let</span> <span class="hljs-variable">num</span> = <span class="hljs-keyword">if</span> condition &#123; <span class="hljs-number">10</span> &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-number">20</span> &#125;;<br></code></pre></td></tr></table></figure><h2 id="Chapter-4"><a href="#Chapter-4" class="headerlink" title="Chapter 4"></a>Chapter 4</h2><p><strong>æ‰€æœ‰æƒ</strong>æ˜¯ Rust ä¸­å¾ˆé‡è¦çš„æ¦‚å¿µï¼Œæ‰€æœ‰ç¨‹åºåœ¨è¿è¡Œæ—¶éƒ½å¿…é¡»ç®¡ç†å®ƒä»¬ä½¿ç”¨è®¡ç®—æœºå†…å­˜çš„æ–¹å¼ã€‚</p><ol><li>æœ‰äº›è¯­è¨€è‡ªå¸¦ GCï¼Œç¨‹åºè¿è¡Œæ—¶ä¼šä¸€ç›´æœç´¢å·²ç»ä¸ç”¨çš„å†…å­˜</li><li>æœ‰äº›è¯­è¨€éœ€è¦ç¨‹åºå‘˜æ˜¾å¼çš„ç”³è¯·å’Œé‡Šæ”¾å†…å­˜</li><li>Rust é€šè¿‡ä¸€ä¸ªæ‰€æœ‰æƒç³»ç»Ÿæ¥ç®¡ç†å†…å­˜ï¼Œå…¶ä¸­åŒ…å«ä¸€ç»„ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶æ£€æµ‹çš„è§„åˆ™</li></ol><p>Rust ä¸­ï¼Œå¯ä»¥å‘ Stack å’Œ Heap ç”³è¯·å†…å­˜ã€‚Stack åªèƒ½å­˜æ”¾<strong>å®šé•¿</strong>çš„æ•°æ®ï¼ŒHeap å¯ä»¥å­˜æ”¾<strong>å˜é•¿</strong>çš„æ•°æ®ã€‚å¾ˆæ˜æ˜¾ï¼Œè®¡ç®—æœºè®¿é—® Stack ä¸Šçš„æ•°æ®å¿«äº Heapï¼Œå› ä¸ºä» Stack è·å–æ•°æ®ä¸€å®šæ˜¯æ ˆé¡¶ï¼Œå¹¶ä¸” Stack ä¸­å„ä¸ªæ•°æ®ç¦»å¾—è¿‘ã€‚</p><p>String ç±»å‹æ˜¯å…¸å‹çš„å˜é•¿æ•°æ®ç±»å‹ï¼Œå®ƒåªèƒ½å­˜æ”¾äº Heap ä¸Šã€‚é€šè¿‡<code>from</code>æ–¹æ³•å¯ä»¥é€šè¿‡å­—ç¬¦ä¸²å¸¸é‡åˆ›å»ºä¸€ä¸ª String ç±»å‹ï¼Œå®ƒå­˜æ”¾äº Heap ä¸Šï¼Œæ‰€ä»¥å®ƒæ˜¯å¯å˜çš„ã€‚</p><p><strong>Drop</strong>, <strong>Move</strong>, <strong>Copy</strong>, <strong>Clone</strong></p><p><strong>Drop</strong> æ¸…ç†è§„åˆ™ï¼š</p><ol><li>å½“ä¸€ä¸ªæ•°æ®<strong>ç¦»å¼€ä½œç”¨åŸŸ</strong>æ—¶ï¼Œç«‹å³é‡Šæ”¾å®ƒå ç”¨çš„å†…å­˜</li><li>å¯¹äºå¤±æ•ˆ(Moved)çš„å˜é‡ï¼Œä¸ä¼šé‡Šæ”¾å®ƒå ç”¨çš„å†…å­˜</li><li>å¯¹äº Stack ä¸Šçš„ç®€å•æ•°æ®ï¼Œä¸éœ€è¦ Drop</li><li>å¯¹äº Heap ä¸Šçš„æ•°æ®ï¼Œéœ€è¦ Drop</li></ol><p><strong>Move</strong> ç§»åŠ¨è§„åˆ™ï¼š</p><ol><li>å¯¹äº Stack æ•°æ®ï¼Œç­‰åŒäº Copy</li><li>å¯¹äº Heap æ•°æ®ï¼Œå‰è€…å°†è¢«<strong>å¤±æ•ˆ</strong><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">num1</span> = <span class="hljs-number">10</span>;<br><span class="hljs-keyword">let</span> <span class="hljs-variable">num2</span> = num1;    <span class="hljs-comment">// copy</span><br><br><span class="hljs-keyword">let</span> <span class="hljs-variable">s1</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;dmx&quot;</span>);<br><span class="hljs-keyword">let</span> <span class="hljs-variable">s2</span> = s1;        <span class="hljs-comment">// s1 moved</span><br><br><span class="hljs-comment">// borrow of moved value: `s1`</span><br><span class="hljs-comment">// println!(&quot;&#123;&#125;&quot;, s1);</span><br><br><span class="hljs-comment">// exit, s2 will be destoryed</span><br></code></pre></td></tr></table></figure></li></ol><p><strong>Copy</strong> æ‹·è´è§„åˆ™ï¼š</p><ol><li>å¦‚æœå˜é‡ä¸€éƒ¨åˆ†åˆ›å»ºäº† Dropï¼Œé‚£ä¹ˆè¯¥å˜é‡ä¸èƒ½æ‹¥æœ‰ Copy</li><li>Copy ç±»å‹çš„å˜é‡ä¸€èˆ¬å­˜æ”¾äº Stack ä¸Šï¼Œä¸éœ€è¦é¢å¤–çš„ Drop æ“ä½œ<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">num1</span> = <span class="hljs-number">10</span>;<br><span class="hljs-keyword">let</span> <span class="hljs-variable">num2</span> = num1;    <span class="hljs-comment">// copy type</span><br></code></pre></td></tr></table></figure></li></ol><p><strong>Clone</strong> å…‹éš†è§„åˆ™ï¼š</p><ol><li>ä½¿ç”¨ clone æ–¹æ³•ï¼Œå¯ä»¥å®ç°æ·±æ‹·è´ï¼Ÿ</li><li>åœ¨ Heap ä¸Šå¼€è¾Ÿæ–°çš„ä¸€å—å†…å­˜<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">s1</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;dmx&quot;</span>);<br><span class="hljs-keyword">let</span> <span class="hljs-variable">s2</span> = s1.<span class="hljs-title function_ invoke__">clone</span>();    <span class="hljs-comment">// s1 still valid</span><br></code></pre></td></tr></table></figure></li></ol><p>å‡½æ•°çš„å‚æ•°ä¼ é€’ä¸­æ‰€æœ‰æƒçš„è½¬ç§»</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>    <span class="hljs-comment">// s è¢«å£°æ˜æœ‰æ•ˆ</span><br><br>    <span class="hljs-title function_ invoke__">takes_ownership</span>(s);<br>    <span class="hljs-comment">// s çš„å€¼è¢«å½“ä½œå‚æ•°ä¼ å…¥å‡½æ•°</span><br>    <span class="hljs-comment">// æ‰€ä»¥å¯ä»¥å½“ä½œ s å·²ç»è¢«ç§»åŠ¨ï¼Œä»è¿™é‡Œå¼€å§‹å·²ç»æ— æ•ˆ</span><br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">x</span> = <span class="hljs-number">5</span>;<br>    <span class="hljs-comment">// x è¢«å£°æ˜æœ‰æ•ˆ</span><br><br>    <span class="hljs-title function_ invoke__">makes_copy</span>(x);<br>    <span class="hljs-comment">// x çš„å€¼è¢«å½“ä½œå‚æ•°ä¼ å…¥å‡½æ•°</span><br>    <span class="hljs-comment">// ä½† x æ˜¯åŸºæœ¬ç±»å‹ï¼Œä¾ç„¶æœ‰æ•ˆ</span><br>    <span class="hljs-comment">// åœ¨è¿™é‡Œä¾ç„¶å¯ä»¥ä½¿ç”¨ x å´ä¸èƒ½ä½¿ç”¨ s</span><br><br>&#125; <span class="hljs-comment">// å‡½æ•°ç»“æŸ, x æ— æ•ˆ, ç„¶åæ˜¯ s. ä½† s å·²è¢«ç§»åŠ¨, æ‰€ä»¥ä¸ç”¨è¢«é‡Šæ”¾</span><br><br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">takes_ownership</span>(some_string: <span class="hljs-type">String</span>) &#123; <br>    <span class="hljs-comment">// ä¸€ä¸ª String å‚æ•° some_string ä¼ å…¥ï¼Œæœ‰æ•ˆ</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, some_string);<br>&#125; <span class="hljs-comment">// å‡½æ•°ç»“æŸ, å‚æ•° some_string åœ¨è¿™é‡Œé‡Šæ”¾</span><br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">makes_copy</span>(some_integer: <span class="hljs-type">i32</span>) &#123; <br>    <span class="hljs-comment">// ä¸€ä¸ª i32 å‚æ•° some_integer ä¼ å…¥ï¼Œæœ‰æ•ˆ</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, some_integer);<br>&#125; <span class="hljs-comment">// å‡½æ•°ç»“æŸ, å‚æ•° some_integer æ˜¯åŸºæœ¬ç±»å‹, æ— éœ€é‡Šæ”¾</span><br></code></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s1</span> = <span class="hljs-title function_ invoke__">gives_ownership</span>();<br>    <span class="hljs-comment">// gives_ownership ç§»åŠ¨å®ƒçš„è¿”å›å€¼åˆ° s1</span><br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s2</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>    <span class="hljs-comment">// s2 è¢«å£°æ˜æœ‰æ•ˆ</span><br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s3</span> = <span class="hljs-title function_ invoke__">takes_and_gives_back</span>(s2);<br>    <span class="hljs-comment">// s2 è¢«å½“ä½œå‚æ•°ç§»åŠ¨, s3 è·å¾—è¿”å›å€¼æ‰€æœ‰æƒ</span><br>&#125; <span class="hljs-comment">// s3 æ— æ•ˆè¢«é‡Šæ”¾, s2 è¢«ç§»åŠ¨, s1 æ— æ•ˆè¢«é‡Šæ”¾.</span><br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">gives_ownership</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">some_string</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>    <span class="hljs-comment">// some_string è¢«å£°æ˜æœ‰æ•ˆ</span><br><br>    <span class="hljs-keyword">return</span> some_string;<br>    <span class="hljs-comment">// some_string è¢«å½“ä½œè¿”å›å€¼ç§»åŠ¨å‡ºå‡½æ•°</span><br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">takes_and_gives_back</span>(a_string: <span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> &#123; <br>    <span class="hljs-comment">// a_string è¢«å£°æ˜æœ‰æ•ˆ</span><br><br>    a_string  <span class="hljs-comment">// a_string è¢«å½“ä½œè¿”å›å€¼ç§»å‡ºå‡½æ•°</span><br>&#125;<br></code></pre></td></tr></table></figure><p>Rust ä¸­çš„<strong>å¼•ç”¨</strong>å’Œ<strong>ç§Ÿå€Ÿ</strong></p><p>å¼•ç”¨æ˜¯ä¸€ç§â€œå€Ÿâ€æ‰€æœ‰æƒçš„è¿‡ç¨‹ï¼Œä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s1</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">len</span> = <span class="hljs-title function_ invoke__">calculate_length</span>(&amp;s1);<br><br>    <span class="hljs-comment">// s1 is borrowed</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;The length of &#x27;&#123;&#125;&#x27; is &#123;&#125;.&quot;</span>, s1, len);<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">calculate_length</span>(s: &amp;<span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>    s.<span class="hljs-title function_ invoke__">len</span>()<br>&#125;<br></code></pre></td></tr></table></figure><p>å€Ÿç”¨åä¸å¯ä»¥ä¿®æ”¹åŸæ•°æ®ï¼Œé™¤éç”¨<code>mut</code>å…³é”®å­—ä¿®é¥°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s1</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;dmx&quot;</span>);<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s2</span> = &amp;<span class="hljs-keyword">mut</span> s1;<br><br>    s2.<span class="hljs-title function_ invoke__">push_str</span>(<span class="hljs-string">&quot;20070206&quot;</span>);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, s2);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸€ä¸ªå˜é‡çš„æŸæ—¶åˆ»çš„å…¨éƒ¨æœ‰æ•ˆå¼•ç”¨å¿…é¡»æ»¡è¶³å¦‚ä¸‹è§„åˆ™ï¼š</p><ol><li>æœ‰è‡³å¤šä¸€ä¸ªå¯å˜å¼•ç”¨</li><li>æœ‰è‹¥å¹²ä¸ªä¸å¯å˜å¼•ç”¨</li><li>å¼•ç”¨å¿…é¡»ä¸€è‡´æœ‰æ•ˆ</li></ol><p>åŒæ—¶ï¼Œåœ¨ Rust ä¸­ä¸å…è®¸æ‚¬ç©ºå¼•ç”¨ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">reference_to_nothing</span> = <span class="hljs-title function_ invoke__">dangle</span>();<br>    <span class="hljs-comment">// null</span><br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">dangle</span>() <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-type">String</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br><br>    &amp;s<br>&#125;<br><span class="hljs-comment">// s will be destoryed</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Learning</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ENGLISH</title>
    <link href="/2024/11/21/ENGLISH/"/>
    <url>/2024/11/21/ENGLISH/</url>
    
    <content type="html"><![CDATA[<h2 id="2024-11-22"><a href="#2024-11-22" class="headerlink" title="2024-11-22"></a>2024-11-22</h2><h3 id="list-1"><a href="#list-1" class="headerlink" title="list 1"></a>list 1</h3><table><thead><tr><th>1</th><th>2</th><th>3</th></tr></thead><tbody><tr><td>account</td><td>benefit</td><td>challenge</td></tr><tr><td>impact</td><td>apply</td><td>focus</td></tr><tr><td>involve</td><td>potential</td><td>promote</td></tr><tr><td>shift</td><td>tend</td><td>access</td></tr><tr><td>resource</td><td>launch</td><td>current</td></tr><tr><td>opportunity</td><td>reflect</td><td>debate</td></tr><tr><td>conduct</td><td>despite</td><td>determine</td></tr><tr><td>purchase</td><td>specific</td><td>senior</td></tr><tr><td>unique</td><td>amount</td><td>agency</td></tr><tr><td>expand</td><td>attitude</td><td>financial</td></tr><tr><td>release</td><td>declare</td><td>institution</td></tr><tr><td>estimate</td><td>pose</td><td>significant</td></tr><tr><td>associate</td><td>assume</td><td>eventually</td></tr><tr><td>replace</td><td>series</td><td>fund</td></tr><tr><td>rank</td><td>respond</td><td>advocate</td></tr><tr><td>boost</td><td>throughout</td><td>define</td></tr><tr><td>establish</td><td>predict</td><td>attach</td></tr><tr><td>campaign</td><td>track</td><td>exchange</td></tr><tr><td>numerous</td><td>expose</td><td>overall</td></tr><tr><td>vehicle</td><td>outcome</td><td>intend</td></tr><tr><td>reveal</td><td>positive</td><td>critical</td></tr><tr><td>survey</td><td>capacity</td><td>enhance</td></tr></tbody></table><h3 id="list-2"><a href="#list-2" class="headerlink" title="list 2"></a>list 2</h3><table><thead><tr><th>1</th><th>2</th><th>3</th></tr></thead><tbody><tr><td>vocal</td><td>officials</td><td>overestimate</td></tr><tr><td>hesitant</td><td>terminate</td><td>invest</td></tr><tr><td>bleak</td><td>inclusiveness</td><td>frontline</td></tr><tr><td>genre</td><td>regulation</td><td>overnight</td></tr><tr><td>distinguish</td><td>money-making</td><td>monolingual</td></tr><tr><td>bilingual</td><td>multilingual</td><td>leather</td></tr><tr><td>substitute</td><td>fierce</td><td>particularly</td></tr><tr><td>obsessed</td><td>cognitive</td><td>elite</td></tr><tr><td>vast</td><td>bulk</td><td>aggressive</td></tr><tr><td>inflation</td><td>cross-country</td><td>church</td></tr><tr><td>dictate</td><td>infant</td><td>struggle</td></tr><tr><td>category</td><td>measure</td><td>interpret</td></tr><tr><td>exotic</td><td>acclaim</td><td>infrastructure</td></tr></tbody></table><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Verilog"><span class="hljs-keyword">reg</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>] total = <span class="hljs-number">66</span> + <span class="hljs-number">39</span>;<br></code></pre></td></tr></table></figure><h2 id="2024-11-24"><a href="#2024-11-24" class="headerlink" title="2024-11-24"></a>2024-11-24</h2><h3 id="list-1-1"><a href="#list-1-1" class="headerlink" title="list 1"></a>list 1</h3><table><thead><tr><th>1</th><th>2</th><th>3</th></tr></thead><tbody><tr><td>executive</td><td>confidence</td><td>motivate</td></tr><tr><td>eliminate</td><td>expense</td><td>peer</td></tr><tr><td>responsibility</td><td>ignore</td><td>commit</td></tr><tr><td>complex</td><td>corporate</td><td>bias</td></tr><tr><td>majority</td><td>distinguish</td><td>alternative</td></tr><tr><td>identify</td><td>invest</td><td>consequence</td></tr><tr><td>spot</td><td>combine</td><td>option</td></tr><tr><td>annual</td><td>discount</td><td>negative</td></tr><tr><td>superior</td><td>obtain</td><td>extreme</td></tr><tr><td>attribute</td><td>assess</td><td>identity</td></tr><tr><td>notion</td><td>rely</td><td>perceive</td></tr><tr><td>staff</td><td>vital</td><td>chain</td></tr><tr><td>yield</td><td>enable</td><td>priority</td></tr><tr><td>consist</td><td>embrace</td><td>imply</td></tr><tr><td>refer</td><td>detail</td><td>recommend</td></tr><tr><td>exhibit</td><td>crucial</td><td>talent</td></tr><tr><td>consume</td><td>relate</td><td>construction</td></tr><tr><td>diminish</td><td>emission</td><td>incentive</td></tr><tr><td>remind</td><td>accelerate</td><td>shrink</td></tr><tr><td>counterpart</td><td>medium</td><td>enormous</td></tr><tr><td>giant</td><td>locate</td><td>ongoing</td></tr><tr><td>status</td><td>thrive</td><td>cater</td></tr><tr><td>transfer</td><td>investigate</td><td>encounter</td></tr><tr><td>essential</td><td>necessarily</td><td></td></tr></tbody></table><h3 id="list-2-1"><a href="#list-2-1" class="headerlink" title="list 2"></a>list 2</h3><table><thead><tr><th>1</th><th>2</th><th>3</th></tr></thead><tbody><tr><td>fellow</td><td>agriculture</td><td>entirely</td></tr><tr><td>presense</td><td>intensify</td><td>foster</td></tr><tr><td>talent</td><td>culturally</td><td>competency</td></tr><tr><td>bond</td><td>exaggerate</td><td>entrepreneur</td></tr><tr><td>permission</td><td>principal</td><td>separate</td></tr><tr><td>weird</td><td>willpower</td><td>faculty</td></tr><tr><td>donate</td><td>maintenance</td><td>campus</td></tr><tr><td>utility</td><td>insight</td><td>fertilizer</td></tr><tr><td>impressively</td><td>policymaker</td><td>tongue</td></tr><tr><td>magnify</td><td>split</td><td>depict</td></tr><tr><td>simul-taneously</td><td>endeavour</td><td>restrict</td></tr><tr><td>composition</td><td>inspirational</td><td>peak</td></tr><tr><td>anxiety</td><td>transition</td><td>harsh</td></tr><tr><td>wither</td><td>contract</td><td>curriculum</td></tr><tr><td>inferior</td><td>ladylike</td><td>devour</td></tr><tr><td>object</td><td>species</td><td>chemical</td></tr><tr><td>favor</td><td>sanctuary</td><td>bold</td></tr></tbody></table><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">total</span>: <span class="hljs-type">u32</span> = <span class="hljs-number">71</span> + <span class="hljs-number">51</span>;<br></code></pre></td></tr></table></figure><h2 id="2024-11-25"><a href="#2024-11-25" class="headerlink" title="2024-11-25"></a>2024-11-25</h2><h3 id="list-1-2"><a href="#list-1-2" class="headerlink" title="list 1"></a>list 1</h3><table><thead><tr><th>1</th><th>2</th><th>3</th></tr></thead><tbody><tr><td>previous</td><td>alter</td><td>institute</td></tr><tr><td>engage</td><td>abandon</td><td>transform</td></tr><tr><td>maintain</td><td>preserve</td><td>budget</td></tr><tr><td>assumption</td><td>cooperation</td><td>demonstrate</td></tr><tr><td>inform</td><td>recession</td><td>regulation</td></tr><tr><td>sophisticated</td><td>upgrade</td><td>abuse</td></tr><tr><td>circumstance</td><td>emerge</td><td>function</td></tr><tr><td>generate</td><td>profit</td><td>label</td></tr><tr><td>oppose</td><td>revenue</td><td>adapt</td></tr><tr><td>behave</td><td>cognitive</td><td>collapse</td></tr><tr><td>curriculum</td><td>exert</td><td>stimulate</td></tr><tr><td>stuff</td><td>bother</td><td>brand</td></tr><tr><td>considerable</td><td>contrast</td><td>indicate</td></tr><tr><td>modify</td><td>scale</td><td>absorb</td></tr><tr><td>candidate</td><td>crash</td><td>statistic</td></tr><tr><td>switch</td><td>tuition</td><td>reserve</td></tr><tr><td>breed</td><td>appreciate</td><td>conflict</td></tr><tr><td>implement</td><td>massive</td><td>highlight</td></tr><tr><td>capable</td><td>crime</td><td>explore</td></tr><tr><td>extend</td><td>meanwhile</td><td>regulate</td></tr><tr><td>cultivate</td><td>luxury</td><td>retain</td></tr><tr><td>due</td><td>latter</td><td>reverse</td></tr><tr><td>reject</td><td>virtue</td><td>sufficient</td></tr><tr><td>profound</td><td>reward</td><td>approach</td></tr><tr><td>appropriate</td><td></td><td></td></tr></tbody></table><h3 id="list-2-2"><a href="#list-2-2" class="headerlink" title="list 2"></a>list 2</h3><table><thead><tr><th>1</th><th>2</th><th>3</th></tr></thead><tbody><tr><td>treatment</td><td>relieve</td><td>figure</td></tr><tr><td>maintenance</td><td>pit</td><td>deposit</td></tr><tr><td>stick</td><td>alien</td><td>ecosystem</td></tr><tr><td>noticeable</td><td>witness</td><td>bankruptcy</td></tr><tr><td>phenomenon</td><td>arrest</td><td>charge</td></tr><tr><td>corruption</td><td>destined</td><td>victorious</td></tr><tr><td>sharply</td><td>regardless</td><td>observe</td></tr><tr><td>progress</td><td>rigorous</td><td>endure</td></tr><tr><td>pierce</td><td>elbow</td><td>snobby</td></tr><tr><td>insurance</td><td>commision</td><td>swamp</td></tr><tr><td>dweller</td><td>federal</td><td>drain</td></tr><tr><td>mental</td><td>lottery</td><td>laborious</td></tr><tr><td>ordeal</td><td>milestone</td><td>wheat</td></tr><tr><td>rupture</td><td>diplomatic</td><td>incident</td></tr><tr><td>infrastructure</td><td>peril</td><td>indeed</td></tr><tr><td>prestige</td><td>brand</td><td>former</td></tr><tr><td>reversible</td><td>pity</td><td>assert</td></tr><tr><td>dominance</td><td>companion</td><td>appropriation</td></tr></tbody></table><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> total = <span class="hljs-number">73</span> + <span class="hljs-number">54</span>;<br></code></pre></td></tr></table></figure><h2 id="2024-11-27"><a href="#2024-11-27" class="headerlink" title="2024-11-27"></a>2024-11-27</h2><h3 id="list-1-3"><a href="#list-1-3" class="headerlink" title="list 1"></a>list 1</h3><table><thead><tr><th>1</th><th>2</th><th>3</th></tr></thead><tbody><tr><td>anticipate</td><td>array</td><td>embed</td></tr><tr><td>expertise</td><td>frame</td><td>grand</td></tr><tr><td>insist</td><td>obstacle</td><td>patent</td></tr><tr><td>peak</td><td>principal</td><td>shed</td></tr><tr><td>prior</td><td>prospect</td><td>remedy</td></tr><tr><td>rigorous</td><td>strengthen</td><td>tackle</td></tr><tr><td>transition</td><td>acknowledge</td><td>deposit</td></tr><tr><td>discourage</td><td>evolve</td><td>fake</td></tr><tr><td>manner</td><td>rival</td><td>severe</td></tr><tr><td>stereotype</td><td>toxic</td><td>vulnerable</td></tr><tr><td>ceremony</td><td>aspect</td><td>capture</td></tr><tr><td>domestic</td><td>endanger</td><td>exaggerate</td></tr><tr><td>indispensable</td><td>passion</td><td>phenomenon</td></tr><tr><td>pile</td><td></td><td></td></tr></tbody></table><h3 id="list-2-3"><a href="#list-2-3" class="headerlink" title="list 2"></a>list 2</h3><table><thead><tr><th>1</th><th>2</th><th>3</th></tr></thead></table><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> total = ;<br></code></pre></td></tr></table></figure><h2 id="2024-11-29"><a href="#2024-11-29" class="headerlink" title="2024-11-29"></a>2024-11-29</h2><h3 id="list-1-4"><a href="#list-1-4" class="headerlink" title="list 1"></a>list 1</h3><table><thead><tr><th>1</th><th>2</th><th>3</th></tr></thead><tbody><tr><td>rare</td><td>rear</td><td>adolescent</td></tr><tr><td>assign</td><td>float</td><td>furthermore</td></tr><tr><td>illustrate</td><td>occupy</td><td>perspective</td></tr><tr><td>register</td><td>relieve</td><td>robust</td></tr><tr><td>ecosystem</td><td>responsible</td><td>fatal</td></tr><tr><td>reproduce</td><td>decrease</td><td>propose</td></tr><tr><td>ultimate</td><td>adjust</td><td>incorporate</td></tr><tr><td>version</td><td>ingredient</td><td>recall</td></tr><tr><td>artificial</td><td>arise</td><td>complain</td></tr><tr><td>differ</td><td>dramatic</td><td>intelligence</td></tr><tr><td>mininum</td><td>obvious</td><td>prosperity</td></tr><tr><td>abstract</td><td>accuse</td><td>intelligent</td></tr><tr><td>tenant</td><td>display</td><td>refrain</td></tr><tr><td>bet</td><td>stable</td><td>underestimate</td></tr><tr><td>compel</td><td>facilitate</td><td>leap</td></tr><tr><td>update</td><td>participate</td><td>resolve</td></tr></tbody></table><h3 id="list-2-4"><a href="#list-2-4" class="headerlink" title="list 2"></a>list 2</h3><table><thead><tr><th>1</th><th>2</th><th>3</th></tr></thead><tbody><tr><td></td><td></td><td></td></tr></tbody></table><h2 id="2024-12-4"><a href="#2024-12-4" class="headerlink" title="2024-12-4"></a>2024-12-4</h2><h3 id="list-2-5"><a href="#list-2-5" class="headerlink" title="list 2"></a>list 2</h3><table><thead><tr><th>1</th><th>2</th><th>3</th></tr></thead><tbody><tr><td>rationality</td><td>discourse</td><td>gradual</td></tr><tr><td>exposition</td><td>assertion</td><td>confine</td></tr><tr><td>overturn</td><td>reduce</td><td>sensationalism</td></tr><tr><td>commerce</td><td>proposition</td><td>commercial</td></tr><tr><td>derive</td><td>grip</td><td>colonize</td></tr><tr><td>instant</td><td>approval</td><td>constantly</td></tr><tr><td>unconsciously</td><td>curiosty</td><td>reason</td></tr><tr><td>supremacy</td><td>conducive</td><td>entitlement</td></tr><tr><td>dysfunction</td><td>legitimately</td><td>generous</td></tr><tr><td>irrespective</td><td>discrepancy</td><td>privilege</td></tr><tr><td>inflate</td><td>slack off</td><td>overindulge</td></tr><tr><td>thereby</td><td>spolit</td><td>nonetheless</td></tr><tr><td>virtue</td><td>heighten</td><td>respondent</td></tr><tr><td>alleviate</td><td>indulge</td><td>accountable</td></tr><tr><td>genuinely</td><td>deviate</td><td>confront</td></tr><tr><td>disincline</td><td>tactfully</td><td>somewhat</td></tr><tr><td>distorte</td><td>criterion</td><td></td></tr></tbody></table><link rel="stylesheet" href="/css/ENGLISH.css"><p><span class="dmx_color"> test </span></p>]]></content>
    
    
    
    <tags>
      
      <tag>Learning</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>miniob åˆèµ›å‚èµ›æ€»ç»“</title>
    <link href="/2024/11/11/miniob/"/>
    <url>/2024/11/11/miniob/</url>
    
    <content type="html"><![CDATA[<h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p>å‚åŠ è¿™ä¸ªæ¯”èµ›å…¶å®ä¸»è¦ç›®çš„æ˜¯èµšé’±ï¼ˆæ„Ÿè°¢å‘¨å¸ˆå§çš„æ ¡å‹åŸºé‡‘ï¼Œæœ€åå«æ³ªæ”¶ä¸‹ 7000ï¿¥ ï¼‰ï¼Œæ‰€ä»¥ä»¥ä¸‹å¾ˆå¤šå†…å®¹å¯èƒ½å¹¶ä¸ä¸“ä¸šã€‚</p><p>æœ€ç»ˆçš„ç»“æœæ˜¯å…¨å›½ç¬¬ 40 åï¼Œè¿›å†³èµ›ä¸€å…±æœ‰ 50 ä¸ªé˜Ÿä¼ï¼Œä¸è¿‡ç”±äºåŠ æƒå‹åŠ›ï¼ˆç›®å‰ä¼°è®¡åŠ æƒç›¸è¾ƒäºå¤§äºŒä¸Šè¦æ‰ 6 åˆ†å·¦å³ï¼‰ï¼Œå†³èµ›ä¸ä¸€å®šä¼šä»˜å‡ºå¤ªå¤šå¿ƒè¡€å»æ‰“äº†ã€‚</p><p>æ„Ÿè°¢æˆ‘çš„é˜Ÿå‹ Sazikk å’Œæˆ‘ä¸€èµ·ç†¬å¤œè‚ä»£ç ï¼Œå¹¶ä¸”å¿è€æˆ‘çš„å±å±±ä»£ç é•¿è¾¾ 21 å¤©ä¹‹ä¹…ã€‚ç”±äºå±å±±å¤ªå¤šäº†ï¼Œæ‰€ä»¥å‡ºç°å±çš„éƒ¨åˆ†ä¼šæ ‡æ³¨ã€‚</p><blockquote><p>Sazikk ä¸ªäººåšå®¢ï¼š<a href="https://sazikk.github.io/">https://sazikk.github.io</a>  ç›®å‰å·²æœ‰æ•°åä¸‡çš„è§‚çœ‹é‡ï¼ˆç‹—å¤´<br>æˆ‘ä»¬çš„é¡¹ç›®ï¼š<a href="https://github.com/SaZiKK/miniob-2024">https://github.com/SaZiKK/miniob-2024</a><br>806 å®˜æ–¹é“¾æ¥ï¼š<a href="https://ustb-806.github.io/blogs/2024/11/oceanbase/">https://ustb-806.github.io/blogs/2024/11/oceanbase/</a></p></blockquote><h2 id="ä¸ªäººå¿ƒå¾—"><a href="#ä¸ªäººå¿ƒå¾—" class="headerlink" title="ä¸ªäººå¿ƒå¾—"></a>ä¸ªäººå¿ƒå¾—</h2><p>å‚åŠ è¿™ä¸ªæ¯”èµ›éœ€è¦ä»€ä¹ˆèƒ½åŠ›ï¼š</p><ol><li>è¾ƒå¼ºçš„ C++ å¼€å‘èƒ½åŠ›</li><li>ä¸€å®šçš„ SQL è¯­è¨€ç†è§£èƒ½åŠ›</li><li>å¯¹ miniob å†…æ ¸æœ‰è¾ƒå¥½çš„ç†è§£</li></ol><h2 id="miniob-æ¡†æ¶è§£æ"><a href="#miniob-æ¡†æ¶è§£æ" class="headerlink" title="miniob æ¡†æ¶è§£æ"></a>miniob æ¡†æ¶è§£æ</h2><h2 id="æˆ‘è´Ÿè´£çš„é¢˜ç›®"><a href="#æˆ‘è´Ÿè´£çš„é¢˜ç›®" class="headerlink" title="æˆ‘è´Ÿè´£çš„é¢˜ç›®"></a>æˆ‘è´Ÿè´£çš„é¢˜ç›®</h2><h3 id="drop-table"><a href="#drop-table" class="headerlink" title="drop table"></a>drop table</h3><p><img src="/img/drop_table.png"></p><p>é¢˜ç›®è¦æ±‚åˆ é™¤æŸä¸ªè¡¨æ ¼ï¼Œä¸€ä¸ªè¡¨æ ¼çš„ä¿¡æ¯åŒ…æ‹¬ä¸‰ç§ï¼šæ•°æ®ä¿¡æ¯ + ç´¢å¼•ä¿¡æ¯ + è¡¨æ ¼å…ƒæ•°æ®</p><ol><li>æ•°æ®ä¿¡æ¯ï¼šçœŸå®å­˜æ”¾åˆ°è¡¨æ ¼å½“ä¸­çš„æ•°æ®</li><li>ç´¢å¼•ä¿¡æ¯ï¼šä¸€ä¸ªç´¢å¼•å¯¹åº”ä¸€æ£µ B+ æ ‘</li><li>è¡¨æ ¼å…ƒæ•°æ®ï¼šå„ç§è¡¨æ ¼çš„æè¿°ä¿¡æ¯</li></ol><p>drop table ä¸éœ€è¦ç®—å­ï¼Œéœ€è¦æ‰§è¡Œå™¨</p><h4 id="å‰ç«¯-lex-yacc-å®Œå–„"><a href="#å‰ç«¯-lex-yacc-å®Œå–„" class="headerlink" title="å‰ç«¯ lex yacc å®Œå–„"></a>å‰ç«¯ lex yacc å®Œå–„</h4><p>lex åŠ å…¥å…³é”®å­— DROP</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">DROP                                    <span class="hljs-title">RETURN_TOKEN</span><span class="hljs-params">(DROP)</span></span>;<br></code></pre></td></tr></table></figure><p>yacc åŠ å…¥è¯­å¥</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C++">drop_table_stmt:<br>    DROP TABLE ID &#123;<br>      $$ = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ParsedSqlNode</span>(SCF_DROP_TABLE);<br>      $$-&gt;drop_table.relation_name = $<span class="hljs-number">3</span>;<br>      <span class="hljs-built_in">free</span>($<span class="hljs-number">3</span>);<br>    &#125;;<br></code></pre></td></tr></table></figure><h4 id="STMT-è®¾è®¡"><a href="#STMT-è®¾è®¡" class="headerlink" title="STMT è®¾è®¡"></a>STMT è®¾è®¡</h4><p>åˆ é™¤è¡¨æ ¼åªéœ€è¦è¡¨æ ¼çš„è¡¨åï¼Œå½“ç„¶æ­£å¸¸æ¥è¯´åœ¨ STMT çº§å°±åº”è¯¥é€šè¿‡è¡¨æ ¼åç§°è·å–åˆ°å®é™…çš„ Table äº†ï¼Œä½†æ˜¯å½“æ—¶å†™çš„æ—¶å€™æ”¾åˆ°äº† Db çš„åˆ é™¤è¡¨æ ¼å‡½æ•°ä¸­ã€‚</p><h4 id="EXECUTE-è®¾è®¡"><a href="#EXECUTE-è®¾è®¡" class="headerlink" title="EXECUTE è®¾è®¡"></a>EXECUTE è®¾è®¡</h4><p>åœ¨æ‰§è¡Œå™¨ä¸­é€šè¿‡è°ƒç”¨ db çš„åˆ é™¤è¡¨æ ¼å‡½æ•°æˆ–è€… table çš„è‡ªæ¯å‡½æ•°ã€‚è¡¨æ ¼çš„è‡ªæ¯å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">RC <span class="hljs-title">Table::drop</span><span class="hljs-params">()</span> </span>&#123;<br><br>  <span class="hljs-comment">// åˆ é™¤æ•°æ®æ–‡ä»¶ data_file</span><br>  string data_file = <span class="hljs-built_in">table_data_file</span>(base_dir_.<span class="hljs-built_in">c_str</span>(), table_meta_.<span class="hljs-built_in">name</span>());<br>  <span class="hljs-built_in">unlink</span>(data_file.<span class="hljs-built_in">c_str</span>());<br><br>  <span class="hljs-comment">// åˆ é™¤ç´¢å¼•æ–‡ä»¶ index_file</span><br>  <span class="hljs-type">int</span> indexNum = table_meta_.<span class="hljs-built_in">index_num</span>();<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; indexNum; i++) &#123;<br>    <span class="hljs-keyword">auto</span> *index_meta = table_meta_.<span class="hljs-built_in">index</span>(i);<br>    string index_file = <span class="hljs-built_in">table_index_file</span>(base_dir_.<span class="hljs-built_in">c_str</span>(), table_meta_.<span class="hljs-built_in">name</span>(), index_meta-&gt;<span class="hljs-built_in">name</span>());<br>    <span class="hljs-built_in">unlink</span>(index_file.<span class="hljs-built_in">c_str</span>());<br>  &#125;<br><br>  <span class="hljs-comment">// åˆ é™¤å…ƒæ–‡ä»¶ meta_file</span><br>  string meta_file = <span class="hljs-built_in">table_meta_file</span>(base_dir_.<span class="hljs-built_in">c_str</span>(), table_meta_.<span class="hljs-built_in">name</span>());<br>  <span class="hljs-built_in">unlink</span>(meta_file.<span class="hljs-built_in">c_str</span>());<br><br>  <span class="hljs-keyword">return</span> RC::SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="update"><a href="#update" class="headerlink" title="update"></a>update</h3><p><img src="/img/update.png"></p><p>è™½ç„¶é¢˜ç›®åªè¦æ±‚å•å­—æ®µçš„æ›´æ–°ï¼Œä½†æ˜¯ç”±äºåé¢å¾ˆå¿«å°±è¦æ‰©å……ï¼Œæ‰€ä»¥ä¸‹é¢ç›´æ¥æ”¾å®Œæ•´ç‰ˆã€‚</p><p>éœ€è¦æ³¨æ„çš„æœ‰ä¸¤ç‚¹ï¼Œå¦‚ä½•å°† åœ¨æŸäº›å­—æ®µä¿®æ”¹ä¸ºæŸå€¼ æ¨å¾— åœ¨å†…å­˜æŸäº›ä½ç½®ä¿®æ”¹äºŒè¿›åˆ¶æ•°æ®ï¼›ä»¥åŠå¯¹äºå¤šä¸ªå­—æ®µçš„æ›´æ–°ï¼Œå¿…é¡»åŒæ—¶æˆåŠŸæˆ–å¤±è´¥ï¼Œä¹Ÿå³å…ˆåˆ¤æ–­åä¿®æ”¹ï¼ˆæˆ–å›æ»šï¼‰ï¼Œä¸ä»…æœ‰å•ä¸ªå­—æ®µé—´çš„å›æ»šï¼Œè¿˜æœ‰å•ä¸ªå…ƒç»„é—´çš„å›æ»šã€‚</p><p>update è¯­å¥ä¸éœ€è¦æ‰§è¡Œå™¨ï¼Œéœ€è¦ç®—å­</p><h4 id="å‰ç«¯-lex-yacc-å®Œå–„-1"><a href="#å‰ç«¯-lex-yacc-å®Œå–„-1" class="headerlink" title="å‰ç«¯ lex yacc å®Œå–„"></a>å‰ç«¯ lex yacc å®Œå–„</h4><p>lex åŠ å…¥å…³é”®å­— UPDATE</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">UPDATE                                  <span class="hljs-title">RETURN_TOKEN</span><span class="hljs-params">(UPDATE)</span></span>;<br></code></pre></td></tr></table></figure><p>yacc åŠ å…¥è¯­å¥<br>å…¶ä¸­ update_target ä¸ºä¸€ä¸ªå­—æ®µçš„æ›´æ–°ï¼Œupdate_target_list ä¸ºè‹¥å¹²å­—æ®µçš„æ›´æ–°ï¼Œwhere ä¸ºè°“è¯è¡¨è¾¾å¼ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs C++">update_stmt:      <span class="hljs-comment">/*  update è¯­å¥çš„è¯­æ³•è§£ææ ‘*/</span><br>    UPDATE ID SET update_target update_target_list where <br>    &#123;<br>      $$ = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ParsedSqlNode</span>(SCF_UPDATE);<br>      $$-&gt;update.relation_name = $<span class="hljs-number">2</span>;<br><br>      <span class="hljs-keyword">if</span> ($<span class="hljs-number">6</span> != <span class="hljs-literal">nullptr</span>) &#123;<br>        $$-&gt;update.conditions.<span class="hljs-built_in">swap</span>(*$<span class="hljs-number">6</span>);<br>        <span class="hljs-keyword">delete</span> $<span class="hljs-number">6</span>;<br>      &#125;<br><br>      <span class="hljs-keyword">if</span>($<span class="hljs-number">5</span> != <span class="hljs-literal">nullptr</span>)<br>        $$-&gt;update.update_targets.<span class="hljs-built_in">swap</span>(*$<span class="hljs-number">5</span>);<br>      $$-&gt;update.update_targets.<span class="hljs-built_in">emplace_back</span>(*$<span class="hljs-number">4</span>);<br>      std::<span class="hljs-built_in">reverse</span>($$-&gt;update.update_targets.<span class="hljs-built_in">begin</span>(), $$-&gt;update.update_targets.<span class="hljs-built_in">end</span>());<br>    &#125;<br>    ;<br></code></pre></td></tr></table></figure><p>å¯¹äº ParseSqlNodeï¼Œæ–°å¢ update è¯­å¥å¯¹åº”çš„ nodeã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">UpdateSqlNode</span> &#123;<br>  std::string relation_name;                <span class="hljs-comment">// æ›´æ–°è¡¨æ ¼åç§°</span><br>  std::vector&lt;UpdateTarget&gt; update_targets; <span class="hljs-comment">// æ›´æ–°å­—æ®µé›†åˆ</span><br>  std::vector&lt;ConditionSqlNode&gt; conditions; <span class="hljs-comment">// è°“è¯æ¡ä»¶</span><br>&#125;;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">UpdateTarget</span> &#123;<br>  <span class="hljs-type">bool</span> is_value;                            <span class="hljs-comment">// æ˜¯å¦ä¸ºç®€å•å€¼ï¼Œæœ¬é¢˜è§†ä½œ true</span><br>  Value value;                              <span class="hljs-comment">// æ›´æ–°çš„å€¼</span><br>  std::string attribute_name;               <span class="hljs-comment">// æ›´æ–°çš„å±æ€§å</span><br>  SubSelectSqlNode *sub_select;             <span class="hljs-comment">// å­æŸ¥è¯¢ï¼Œåé¢ä¹ é¢˜æ¶‰åŠ</span><br>&#125;;<br></code></pre></td></tr></table></figure><h4 id="STMT-è®¾è®¡-1"><a href="#STMT-è®¾è®¡-1" class="headerlink" title="STMT è®¾è®¡"></a>STMT è®¾è®¡</h4><p>update è¯­å¥å¯¹åº”çš„ STMT ä¸­åŒ…å«ï¼šæ‰€æœ‰ä¿®æ”¹åŸŸä¿¡æ¯(FieldMeta)ï¼Œç›®æ ‡è¡¨æ ¼ï¼Œç­›é€‰å¯¹åº”çš„ STMT(FilterStmt)ï¼Œä»¥åŠå¤„ç†å¥½çš„ UpdateTarget æ•°ç»„ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œæ‹¿åˆ°è¡¨æ ¼</p><p>ç¬¬äºŒæ­¥ï¼Œé€šè¿‡æ‰€æœ‰ä¿®æ”¹åŸŸçš„åç§°ï¼Œæ‹¿åˆ°å…¨éƒ¨ä¿®æ”¹åŸŸï¼Œæ³¨æ„é¡ºåºæ˜¯ä¸é‡è¦çš„ï¼Œå› ä¸ºå®ƒä»¬éƒ½æ˜¯åŒæ—¶æˆåŠŸæˆ–åŒæ—¶å¤±è´¥çš„ã€‚</p><p>ç¬¬ä¸‰æ­¥ï¼Œå¦‚æœæœ‰å­æŸ¥è¯¢éœ€è¦å°†å­æŸ¥è¯¢è½¬åŒ–ä¸ºä¸€ä¸ª Valueï¼Œåé¢å¯¹åº”çš„é¢˜å†è§£é‡Šã€‚</p><h4 id="é€»è¾‘ç®—å­å’Œç‰©ç†ç®—å­è®¾è®¡"><a href="#é€»è¾‘ç®—å­å’Œç‰©ç†ç®—å­è®¾è®¡" class="headerlink" title="é€»è¾‘ç®—å­å’Œç‰©ç†ç®—å­è®¾è®¡"></a>é€»è¾‘ç®—å­å’Œç‰©ç†ç®—å­è®¾è®¡</h4><p>é€»è¾‘ç®—å­ä¸­éœ€è¦åŒ…å«è¡¨æ ¼ä»¥åŠä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„è¡¨ç¤ºéœ€è¦æ›´æ–°çš„åŸŸå’Œå€¼ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C++">Table *table_ = <span class="hljs-literal">nullptr</span>;<br>std::vector&lt;std::pair&lt;Value, FieldMeta&gt;&gt; update_map_;<br></code></pre></td></tr></table></figure><p>ç‰©ç†ç®—å­ç›´æ¥ç»§æ‰¿é€»è¾‘ç®—å­ä¸­çš„è¡¨æ ¼å’Œ&lt;åŸŸ, å€¼&gt;æ•°ç»„ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜éœ€è¦åŒ…å«ä¸€ä¸ª Record æ•°ç»„ï¼Œå› ä¸ºæˆ‘ä»¬è¦å¤„ç†å•ä¸ªå…ƒç»„çš„å›æ»šã€‚åœ¨å­˜åœ¨ unique index çš„æƒ…å¢ƒä¸‹ï¼Œä¸€æ¡ update è¯­å¥å¯èƒ½å¯¹å¤šä¸ªå…ƒç»„è¿›è¡Œä¿®æ”¹ï¼Œ<br>å¦‚æœä¿®æ”¹æ—¶å‘ç°æŸä¸€æ¡å…ƒç»„çš„ä¿®æ”¹æ˜¯éæ³•çš„ï¼Œåˆ™ä¹‹å‰æ‰€æœ‰çš„ä¿®æ”¹éƒ½è¦æ’¤å›ã€‚æ­¤å¤„å­˜æ”¾ä¿®æ”¹å‰çš„ Record æ•°ç»„æ–¹ä¾¿å›æ»šã€‚è€Œå¯¹äºå•ä¸ªå­—æ®µçš„å›æ»šï¼Œæˆ‘ä»¬é‡‡å–å…ˆåˆ¤æ–­åˆæ³•å†ä¿®æ”¹çš„ç­–ç•¥ï¼Œä¹Ÿå³åªæœ‰å…¨éƒ¨å­—æ®µçš„ä¿®æ”¹éƒ½æ˜¯æœ‰æ•ˆçš„<br>æ‰ä¼šå¼€å§‹å®é™…çš„ä¿®æ”¹ã€‚</p><p>ä¾‹å¦‚ï¼š </p><table><thead><tr><th>id</th><th>num</th><th>col</th></tr></thead><tbody><tr><td>id1</td><td>num1</td><td>col1</td></tr><tr><td>id2</td><td>num2</td><td>col2</td></tr><tr><td>id3</td><td>num3</td><td>col3</td></tr></tbody></table><p>update è¯­å¥éœ€è¦ä¿®æ”¹ç¬¬ä¸€ä¸ªå…ƒç»„å’Œç¬¬ä¸‰ä¸ªå…ƒç»„çš„ id, col å­—æ®µã€‚</p><p>å…ƒç»„çº§åˆ«çš„å›æ»šï¼šæ›´æ–°ç¬¬ä¸€ä¸ªå…ƒç»„æ²¡é—®é¢˜ï¼Œä½†æ˜¯æ›´æ–°ç¬¬ä¸‰ä¸ªå…ƒç»„æ˜¯éæ³•çš„ã€‚</p><p>å­—æ®µçº§åˆ«çš„å›æ»šï¼šæ›´æ–°æŸä¸ªå…ƒç»„æ—¶ï¼Œæ›´æ–° id åŸŸæ²¡é—®é¢˜ï¼Œä½†æ˜¯æ›´æ–° col åŸŸæ˜¯éæ³•çš„ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C++">Table *table_ = <span class="hljs-literal">nullptr</span>;<br>Trx *trx_ = <span class="hljs-literal">nullptr</span>;<br>std::vector&lt;std::pair&lt;Value, FieldMeta&gt;&gt; update_map_;<br>std::vector&lt;Record&gt; records_;<br></code></pre></td></tr></table></figure><p>ç‰©ç†ç®—å­ open å‡½æ•°è®¾è®¡ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// main_tuple æ¶‰åŠåˆ°å¤æ‚å­æŸ¥è¯¢</span><br><span class="hljs-function">RC <span class="hljs-title">UpdatePhysicalOperator::open</span><span class="hljs-params">(Trx *trx, <span class="hljs-type">const</span> Tuple *main_tuple)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (children_.<span class="hljs-built_in">empty</span>()) &#123;<br>    <span class="hljs-keyword">return</span> RC::SUCCESS;<br>  &#125;<br><br>  std::unique_ptr&lt;PhysicalOperator&gt; &amp;child = children_[<span class="hljs-number">0</span>];<br><br>  <span class="hljs-comment">// è°ƒç”¨å­ç®—å­çš„ open å‡½æ•°</span><br>  RC rc = child-&gt;<span class="hljs-built_in">open</span>(trx, main_tuple);<br>  <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) &#123;<br>    <span class="hljs-built_in">LOG_WARN</span>(<span class="hljs-string">&quot;failed to open child operator: %s&quot;</span>, <span class="hljs-built_in">strrc</span>(rc));<br>    <span class="hljs-keyword">return</span> rc;<br>  &#125;<br><br>  trx_ = trx;<br><br>  <span class="hljs-comment">// æ”¶é›†å…¨éƒ¨å…ƒç»„</span><br>  <span class="hljs-keyword">while</span> (<span class="hljs-built_in">OB_SUCC</span>(rc = child-&gt;<span class="hljs-built_in">next</span>(main_tuple))) &#123;<br>    Tuple *tuple = child-&gt;<span class="hljs-built_in">current_tuple</span>();<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">nullptr</span> == tuple) &#123;<br>      <span class="hljs-keyword">return</span> rc;<br>    &#125;<br><br>    RowTuple *row_tuple = <span class="hljs-built_in">static_cast</span>&lt;RowTuple *&gt;(tuple);<br>    Record &amp;record = row_tuple-&gt;<span class="hljs-built_in">record</span>();<br>    records_.<span class="hljs-built_in">emplace_back</span>(std::<span class="hljs-built_in">move</span>(record));<br>  &#125;<br><br>  child-&gt;<span class="hljs-built_in">close</span>();<br><br>  <span class="hljs-keyword">if</span> (records_.<span class="hljs-built_in">empty</span>()) &#123;<br>    <span class="hljs-built_in">LOG_WARN</span>(<span class="hljs-string">&quot;no records to update&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// å°†è¿™äº›å…ƒç»„æ•°æ®æ‹·è´åˆ°ä¸€ä¸ªæ–°æ•°ç»„ä¸­ï¼Œç”¨äºå›æ»š</span><br>  std::vector&lt;<span class="hljs-type">char</span> *&gt; backup_datas;<br>  <span class="hljs-keyword">for</span> (Record &amp;record : records_) &#123;<br>    Record backup_record;<br>    <span class="hljs-type">char</span> *old_data = record.<span class="hljs-built_in">data</span>();<br>    <span class="hljs-type">char</span> *backup_data = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(record.<span class="hljs-built_in">len</span>());<br>    <span class="hljs-built_in">memcpy</span>(backup_data, old_data, record.<span class="hljs-built_in">len</span>());<br><br>    backup_datas.<span class="hljs-built_in">push_back</span>(backup_data);<br>  &#125;<br><br>  <span class="hljs-type">size_t</span> update_num = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">// å…ˆæ”¶é›†è®°å½•å†æ›´æ–°</span><br>  <span class="hljs-keyword">for</span> (Record &amp;record : records_) &#123;<br>    rc = trx_-&gt;<span class="hljs-built_in">update_records</span>(table_, record, update_map_);<br>    ++update_num;<br>    <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) &#123;<br>      <span class="hljs-comment">// å¦‚æœæ›´æ–°å¤±è´¥ï¼Œéœ€è¦å›æ»šï¼Œé‡æ–°å°†ä¿®æ”¹è¿‡çš„å…ƒç»„å¤åŸ</span><br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (<span class="hljs-type">int</span>)update_num; ++i) &#123;<br>        <span class="hljs-type">char</span> *backup_data = backup_datas[i];<br>        Record &amp;record = records_[i];<br><br>        record.<span class="hljs-built_in">set_data</span>(backup_data);<br>        table_-&gt;<span class="hljs-built_in">record_handler</span>()-&gt;<span class="hljs-built_in">update_record</span>(&amp;record);<br>      &#125;<br>      <span class="hljs-keyword">return</span> rc;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> RC::SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure><p>update ç®—å­ä¸€èˆ¬æ²¡æœ‰ä¸Šå±‚ç®—å­ï¼Œæ‰€ä»¥ä¸éœ€è¦ next å‡½æ•°ï¼Œopen å‡½æ•°ä¸­è°ƒç”¨äº†å­ç®—å­çš„ close å‡½æ•°ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦ close å‡½æ•°ã€‚ä½†ç†è®ºä¸Šå­ç®—å­çš„ close å‡½æ•°æ”¾åˆ° update ç®—å­çš„ close å‡½æ•°ä¸­ä¼šæ›´å¥½ã€‚<br>ä¸è¿‡ delete ç®—å­ä¸­ä¹Ÿæ˜¯è¿™ä¹ˆå†™çš„ï¼Œæ‰€ä»¥æ­¤å¤„ä¸ä¿®æ”¹äº†ã€‚</p><h3 id="expression"><a href="#expression" class="headerlink" title="expression"></a>expression</h3><p><img src="/img/expression.png"></p><h4 id="å°†ä¸‡ç‰©éƒ½æ”¹æˆ-expression-çš„è¿‡ç¨‹"><a href="#å°†ä¸‡ç‰©éƒ½æ”¹æˆ-expression-çš„è¿‡ç¨‹" class="headerlink" title="å°†ä¸‡ç‰©éƒ½æ”¹æˆ expression çš„è¿‡ç¨‹"></a>å°†ä¸‡ç‰©éƒ½æ”¹æˆ expression çš„è¿‡ç¨‹</h4><p>1.å°†è°“è¯è¯­å¥çš„ value&#x2F;field op value&#x2F;field ç»“æ„æ”¹æˆ expression op expression<br>2.åˆå§‹çš„ FilterObj ä¸­çš„ expression åªèƒ½æ˜¯ value&#x2F;fieldï¼Œæ‰©å±•ä½¿å¾— expression å¯ä»¥æ˜¯ä»»ä½•ç±»å‹</p><p>ä¹‹å‰æåˆ°è¿‡ï¼Œåœ¨ select è¯­å¥ä¸­ï¼Œä¼šå°†æŸ¥è¯¢çš„è¡¨è¾¾å¼è¿›è¡Œç»‘å®šï¼Œä¾‹å¦‚å°† UnboundField ç»‘å®šä¸º Fieldã€‚åœ¨ Filter éƒ¨åˆ†ï¼Œå¦‚æœæƒ³è¦æ”¯æŒä»»ä½•ç±»å‹çš„ expressionï¼Œä¹Ÿéœ€è¦ç»‘å®šçš„ç¯èŠ‚ã€‚miniob åˆå§‹çš„æ¡†æ¶åªåŒ…å«äº†å¯¹ UnboundField çš„ç»‘å®šï¼Œ<br>ä¹Ÿå³åªå®Œæˆäº†é€šè¿‡åå­—å¯»æ‰¾ç‰¹å®šåŸŸçš„åŠŸèƒ½ã€‚</p><p>ç†è®ºä¸Šï¼Œåº”è¯¥æ¨¡ä»¿ select è¯­å¥çš„ç»‘å®šï¼Œä½¿ç”¨ ExpressionBinder ç±»æ¥å®Œæˆç»‘å®šçš„è¡Œä¸ºï¼Œä½†å½“æ—¶å†™çš„è¿‡äºæ½¦è‰ï¼Œé‡‡ç”¨äº†çº¯ç²¹çš„ switch æ¥å®Œæˆã€‚ä¾‹å¦‚åœ¨ä¸‹é¢çš„ä»£ç ä¸­å®Œæˆäº†å¯¹è¡¨è¾¾å¼ expr çš„ç»‘å®šã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// use_flag æ˜¯å¼ƒç”¨çš„(æ—¶é—´å…³ç³»æœªåˆ é™¤)ï¼Œalias_map ä¸ºåˆ«åéƒ¨åˆ†ï¼Œtable_map ä¸ºå¤æ‚å­æŸ¥è¯¢ä¸­çš„ä¼ é€’æƒ…å†µ</span><br><span class="hljs-comment">// expr æ˜¯éœ€è¦ç»‘å®šçš„è¡¨è¾¾å¼ï¼Œä¹Ÿæ˜¯ä¸€æ¡è°“è¯è¯­å¥çš„ä¸€ç«¯</span><br><span class="hljs-function">RC <span class="hljs-title">FilterStmt::bind_filter_expr</span><span class="hljs-params">(Db *db, Table *default_table, std::unordered_map&lt;std::string, Table *&gt; *tables, unique_ptr&lt;Expression&gt; &amp;expr,</span></span><br><span class="hljs-params"><span class="hljs-function">                                <span class="hljs-type">bool</span> &amp;use_flag, std::unordered_map&lt;string, string&gt; alias_map, std::unordered_map&lt;string, Table *&gt; table_map)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (expr == <span class="hljs-literal">nullptr</span>) <span class="hljs-keyword">return</span> RC::INVALID_ARGUMENT;<br><br>  <span class="hljs-comment">// TODO ç›´æ¥ä½¿ç”¨ expression_binder ä¸­çš„å‡½æ•°è¿›è¡Œ</span><br><br>  <span class="hljs-comment">// æ ¹æ®è¡¨è¾¾å¼çš„ä¸åŒç±»å‹éœ€è¦è¿›è¡Œä¸åŒçš„æ“ä½œ</span><br>  <span class="hljs-keyword">switch</span> (expr-&gt;<span class="hljs-built_in">type</span>()) &#123;<br>    <span class="hljs-keyword">case</span> ExprType::VALUE: &#123;<br>      Value value;<br>      RC rc = expr-&gt;<span class="hljs-built_in">try_get_value</span>(value);<br>      <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) <span class="hljs-keyword">return</span> rc;<br>      <span class="hljs-keyword">if</span> (value.<span class="hljs-built_in">attr_type</span>() == AttrType::DATE &amp;&amp; !DateType::<span class="hljs-built_in">check_date</span>(&amp;value)) <span class="hljs-keyword">return</span> RC::INVALID_ARGUMENT;<br>    &#125; <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> ExprType::VALUELIST: &#123;<br>      std::vector&lt;Value&gt; value_list;<br>      RC rc = expr-&gt;<span class="hljs-built_in">get_value_list</span>(value_list);<br>      <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) <span class="hljs-keyword">return</span> rc;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it : value_list)<br>        <span class="hljs-keyword">if</span> (it.<span class="hljs-built_in">attr_type</span>() == AttrType::DATE &amp;&amp; !DateType::<span class="hljs-built_in">check_date</span>(&amp;it)) <span class="hljs-keyword">return</span> RC::INVALID_ARGUMENT;<br>    &#125; <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> ExprType::SUBQUERY: &#123;<br>      <span class="hljs-keyword">return</span> RC::SUCCESS;<br>    &#125; <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> ExprType::UNBOUND_FIELD: &#123;<br>      Table *table = <span class="hljs-literal">nullptr</span>;<br>      <span class="hljs-type">const</span> FieldMeta *field = <span class="hljs-literal">nullptr</span>;<br>      RC rc = <span class="hljs-built_in">get_table_and_field</span>(db, default_table, tables, expr.<span class="hljs-built_in">get</span>(), table, field, use_flag, alias_map, table_map);<br>      <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) <span class="hljs-keyword">return</span> rc;<br>      expr = std::<span class="hljs-built_in">make_unique</span>&lt;FieldExpr&gt;(table, field);<br>    &#125; <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> ExprType::ARITHMETIC: &#123;<br>      RC rc = RC::SUCCESS;<br>      ArithmeticExpr *arith_expr = <span class="hljs-built_in">static_cast</span>&lt;ArithmeticExpr *&gt;(expr.<span class="hljs-built_in">get</span>());<br>      <span class="hljs-keyword">if</span> (arith_expr-&gt;<span class="hljs-built_in">left</span>() != <span class="hljs-literal">nullptr</span>) &#123;<br>        rc = <span class="hljs-built_in">bind_filter_expr</span>(db, default_table, tables, arith_expr-&gt;<span class="hljs-built_in">left</span>(), use_flag, alias_map, table_map);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) <span class="hljs-keyword">return</span> rc;<br>      <span class="hljs-keyword">if</span> (arith_expr-&gt;<span class="hljs-built_in">right</span>() != <span class="hljs-literal">nullptr</span>) &#123;<br>        rc = <span class="hljs-built_in">bind_filter_expr</span>(db, default_table, tables, arith_expr-&gt;<span class="hljs-built_in">right</span>(), use_flag, alias_map, table_map);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) <span class="hljs-keyword">return</span> rc;<br>    &#125; <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> ExprType::VECFUNC: &#123;<br>      RC rc = RC::SUCCESS;<br>      VecFuncExpr *vec_func_expr = <span class="hljs-built_in">static_cast</span>&lt;VecFuncExpr *&gt;(expr.<span class="hljs-built_in">get</span>());<br>      <span class="hljs-keyword">if</span> (vec_func_expr-&gt;<span class="hljs-built_in">child_left</span>() != <span class="hljs-literal">nullptr</span>) &#123;<br>        rc = <span class="hljs-built_in">bind_filter_expr</span>(db, default_table, tables, vec_func_expr-&gt;<span class="hljs-built_in">child_left</span>(), use_flag, alias_map, table_map);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) <span class="hljs-keyword">return</span> rc;<br>      <span class="hljs-keyword">if</span> (vec_func_expr-&gt;<span class="hljs-built_in">child_right</span>() != <span class="hljs-literal">nullptr</span>) &#123;<br>        rc = <span class="hljs-built_in">bind_filter_expr</span>(db, default_table, tables, vec_func_expr-&gt;<span class="hljs-built_in">child_right</span>(), use_flag, alias_map, table_map);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) <span class="hljs-keyword">return</span> rc;<br>    &#125; <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> ExprType::UNBOUND_AGGREGATION: &#123;<br>      RC rc = RC::SUCCESS;<br>      <span class="hljs-keyword">auto</span> unbound_aggregate_expr = <span class="hljs-built_in">static_cast</span>&lt;UnboundAggregateExpr *&gt;(expr.<span class="hljs-built_in">get</span>());<br>      string name = unbound_aggregate_expr-&gt;<span class="hljs-built_in">name</span>();<br>      <span class="hljs-type">const</span> <span class="hljs-type">char</span> *aggregate_name = unbound_aggregate_expr-&gt;<span class="hljs-built_in">aggregate_name</span>();<br><br>      AggregateExpr::Type aggregate_type;<br>      rc = AggregateExpr::<span class="hljs-built_in">type_from_string</span>(aggregate_name, aggregate_type);<br>      <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) <span class="hljs-keyword">return</span> rc;<br><br>      unique_ptr&lt;Expression&gt; &amp;child_expr = unbound_aggregate_expr-&gt;<span class="hljs-built_in">child</span>();<br><br>      <span class="hljs-keyword">if</span> (child_expr == <span class="hljs-literal">nullptr</span>) <span class="hljs-keyword">return</span> RC::INVALID_ARGUMENT;<br><br>      <span class="hljs-keyword">if</span> (child_expr-&gt;<span class="hljs-built_in">type</span>() == ExprType::STAR &amp;&amp; aggregate_type == AggregateExpr::Type::COUNT) &#123;<br>        ValueExpr *value_expr = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ValueExpr</span>(<span class="hljs-built_in">Value</span>(<span class="hljs-number">1</span>));<br>        child_expr.<span class="hljs-built_in">reset</span>(value_expr);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        rc = <span class="hljs-built_in">bind_filter_expr</span>(db, default_table, tables, child_expr, use_flag, alias_map, table_map);<br>        <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) <span class="hljs-keyword">return</span> rc;<br>      &#125;<br><br>      <span class="hljs-comment">// TODO æ ¡éªŒèšåˆè¡¨è¾¾å¼</span><br>      expr = <span class="hljs-built_in">make_unique</span>&lt;AggregateExpr&gt;(aggregate_type, std::<span class="hljs-built_in">move</span>(child_expr));<br>      expr-&gt;<span class="hljs-built_in">set_name</span>(name);<br>    &#125; <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>      <span class="hljs-keyword">return</span> RC::INVALID_ARGUMENT;<br>      <span class="hljs-keyword">break</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> RC::SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ç„¶ï¼ŒFilterObj ä¹Ÿéœ€è¦æ”¹æˆ expressionï¼Œè€Œä¸æ˜¯ä¹‹å‰çš„ field&#x2F;value æ¨¡å¼ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">FilterObj</span> &#123;<br>  std::unique_ptr&lt;Expression&gt; expr;<br>  <span class="hljs-type">void</span> <span class="hljs-keyword">operator</span>=(FilterObj &amp;obj) &#123; <span class="hljs-keyword">this</span>-&gt;expr = std::<span class="hljs-built_in">move</span>(obj.expr); &#125;<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">(std::unique_ptr&lt;Expression&gt; expr)</span> </span>&#123; <span class="hljs-keyword">this</span>-&gt;expr = std::<span class="hljs-built_in">move</span>(expr); &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨ yacc ä¸­ï¼Œä¹Ÿéœ€è¦è¿›è¡Œä¿®æ”¹ï¼Œcondition éƒ¨åˆ†éœ€è¦æ”¹æˆå·¦å³éƒ½ä¸º expressionã€‚å…¶ä¸­è™½ç„¶æˆ‘ä»¬å°†å­æŸ¥è¯¢ä¹Ÿè®¾è®¡æˆäº†è¡¨è¾¾å¼ï¼Œä½†æ˜¯åœ¨è§£æçš„æ—¶å€™ï¼Œå­æŸ¥è¯¢å¹¶ä¸ç®—ä¸º expressionï¼Œå¦åˆ™ä¼šå‡ºç°å†²çªã€‚<br>æ‰€ä»¥æ­¤å¤„æˆ‘ä»¬å…ˆé€šè¿‡ sub_select_stmt æ¥è¯†åˆ«ï¼Œåœ¨åé¢å°†å…¶è½¬åŒ–ä¸º expressionï¼Œä»è€Œå’Œå…¶ä»– expression ä¸€èµ·å¤„ç†ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs C++">expression comp_op<br>    &#123;<br>      $$ = <span class="hljs-keyword">new</span> ConditionSqlNode;<br>      $$-&gt;left_is_sub_query = <span class="hljs-literal">false</span>;<br>      $$-&gt;right_is_sub_query = <span class="hljs-literal">false</span>;<br>      $$-&gt;comp = $<span class="hljs-number">2</span>;<br>      $$-&gt;left_expression = $<span class="hljs-number">1</span>;<br>      $$-&gt;right_expression = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ValueExpr</span>(<span class="hljs-built_in">Value</span>(<span class="hljs-number">114514</span>));<br>    &#125;<br>    | expression comp_op sub_select_stmt<br>    &#123;<br>      $$ = <span class="hljs-keyword">new</span> ConditionSqlNode;<br>      $$-&gt;left_is_sub_query = <span class="hljs-literal">false</span>;<br>      $$-&gt;right_is_sub_query = <span class="hljs-literal">true</span>;<br>      $$-&gt;comp = $<span class="hljs-number">2</span>;<br>      $$-&gt;left_expression = $<span class="hljs-number">1</span>;<br>      $$-&gt;right_sub_query = $<span class="hljs-number">3</span>;<br>      $$-&gt;right_expression = <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    | sub_select_stmt comp_op sub_select_stmt<br>    &#123;<br>      $$ = <span class="hljs-keyword">new</span> ConditionSqlNode;<br>      $$-&gt;left_is_sub_query = <span class="hljs-literal">true</span>;<br>      $$-&gt;right_is_sub_query = <span class="hljs-literal">true</span>;<br>      $$-&gt;comp = $<span class="hljs-number">2</span>;<br>      $$-&gt;left_sub_query = $<span class="hljs-number">1</span>;<br>      $$-&gt;left_expression = <span class="hljs-literal">nullptr</span>;<br>      $$-&gt;right_sub_query = $<span class="hljs-number">3</span>;<br>      $$-&gt;right_expression = <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    | sub_select_stmt comp_op expression<br>    &#123;<br>      $$ = <span class="hljs-keyword">new</span> ConditionSqlNode;<br>      $$-&gt;left_is_sub_query = <span class="hljs-literal">true</span>;<br>      $$-&gt;right_is_sub_query = <span class="hljs-literal">false</span>;<br>      $$-&gt;comp = $<span class="hljs-number">2</span>;<br>      $$-&gt;left_sub_query = $<span class="hljs-number">1</span>;<br>      $$-&gt;left_expression = <span class="hljs-literal">nullptr</span>;<br>      $$-&gt;right_expression = $<span class="hljs-number">3</span>;<br>    &#125;<br>    | expression comp_op expression<br>    &#123;<br>      $$ = <span class="hljs-keyword">new</span> ConditionSqlNode;<br>      $$-&gt;left_is_sub_query = <span class="hljs-literal">false</span>;<br>      $$-&gt;right_is_sub_query = <span class="hljs-literal">false</span>;<br>      $$-&gt;comp = $<span class="hljs-number">2</span>;<br>      $$-&gt;left_expression = $<span class="hljs-number">1</span>;<br>      $$-&gt;right_expression = $<span class="hljs-number">3</span>;<br>    &#125;<br>    | comp_op sub_select_stmt<br>    &#123;<br>      $$ = <span class="hljs-keyword">new</span> ConditionSqlNode;<br>      $$-&gt;left_is_sub_query = <span class="hljs-literal">false</span>;<br>      $$-&gt;right_is_sub_query = <span class="hljs-literal">true</span>;<br>      $$-&gt;right_sub_query = $<span class="hljs-number">2</span>;<br>      $$-&gt;comp = $<span class="hljs-number">1</span>;<br>      $$-&gt;left_expression = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ValueExpr</span>(<span class="hljs-built_in">Value</span>(<span class="hljs-number">114514</span>));<br>    &#125;<br>    | expression comp_op LBRACE value value_list RBRACE %prec HIGHER_THAN_EXPRESSION<br>    &#123;<br>      $$ = <span class="hljs-keyword">new</span> ConditionSqlNode;<br>      $$-&gt;left_is_sub_query = <span class="hljs-literal">false</span>;<br>      $$-&gt;right_is_sub_query = <span class="hljs-literal">false</span>;<br>      $$-&gt;comp = $<span class="hljs-number">2</span>;<br>      $$-&gt;left_expression = $<span class="hljs-number">1</span>;<br>      $<span class="hljs-number">5</span>-&gt;<span class="hljs-built_in">push_back</span>(*$<span class="hljs-number">4</span>);<br>      $$-&gt;right_expression = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ValueListExpr</span>(*$<span class="hljs-number">5</span>);<br>    &#125;<br>    ;<br></code></pre></td></tr></table></figure><p>åœ¨åé¢çš„æ—¥å­ä¸­ï¼Œæˆ‘ä»¬å°†èƒ½æ”¹çš„éƒ½æ”¹æˆäº† expressionï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief è¡¨è¾¾å¼ç±»å‹</span><br><span class="hljs-comment"> * @ingroup Expression</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">ExprType</span> &#123;<br>  NONE,<br>  STAR,                 <span class="hljs-comment">///&lt; æ˜Ÿå·ï¼Œè¡¨ç¤ºæ‰€æœ‰å­—æ®µ</span><br>  UNBOUND_FIELD,        <span class="hljs-comment">///&lt; æœªç»‘å®šçš„å­—æ®µï¼Œéœ€è¦åœ¨resolveré˜¶æ®µè§£æä¸ºFieldExpr</span><br>  UNBOUND_TABLE,        <span class="hljs-comment">///&lt; æœªç»‘å®šçš„è¡¨æ˜ï¼Œéœ€è¦åœ¨resolveré˜¶æ®µæå–åˆ«åå’ŒåŸå</span><br>  UNBOUND_AGGREGATION,  <span class="hljs-comment">///&lt; æœªç»‘å®šçš„èšåˆå‡½æ•°ï¼Œéœ€è¦åœ¨resolveré˜¶æ®µè§£æä¸ºAggregateExpr</span><br><br>  ALIAS,        <span class="hljs-comment">///&lt; åˆ«å</span><br>  FIELD,        <span class="hljs-comment">///&lt; å­—æ®µã€‚åœ¨å®é™…æ‰§è¡Œæ—¶ï¼Œæ ¹æ®è¡Œæ•°æ®å†…å®¹æå–å¯¹åº”å­—æ®µçš„å€¼</span><br>  JOINTABLE,    <span class="hljs-comment">///&lt; join å­—æ®µ</span><br>  ORDERBY,      <span class="hljs-comment">///&lt; order å­—æ®µ</span><br>  VALUE,        <span class="hljs-comment">///&lt; å¸¸é‡å€¼</span><br>  VALUELIST,    <span class="hljs-comment">///&lt; å¸¸é‡å€¼åˆ—è¡¨</span><br>  CAST,         <span class="hljs-comment">///&lt; éœ€è¦åšç±»å‹è½¬æ¢çš„è¡¨è¾¾å¼</span><br>  COMPARISON,   <span class="hljs-comment">///&lt; éœ€è¦åšæ¯”è¾ƒçš„è¡¨è¾¾å¼</span><br>  CONJUNCTION,  <span class="hljs-comment">///&lt; å¤šä¸ªè¡¨è¾¾å¼ä½¿ç”¨åŒä¸€ç§å…³ç³»(ANDæˆ–OR)æ¥è”ç»“</span><br>  ARITHMETIC,   <span class="hljs-comment">///&lt; ç®—æœ¯è¿ç®—</span><br>  AGGREGATION,  <span class="hljs-comment">///&lt; èšåˆè¿ç®—</span><br>  SUBQUERY,     <span class="hljs-comment">///&lt; å­æŸ¥è¯¢</span><br>  FUNC,         <span class="hljs-comment">///&lt; å‡½æ•°è¿ç®—</span><br>  VECFUNC,      <span class="hljs-comment">///&lt; å‘é‡å‡½æ•°è¿ç®—</span><br>&#125;;<br></code></pre></td></tr></table></figure><h4 id="ä¿®æ”¹é€»è¾‘ç®—å­ç”Ÿæˆå™¨"><a href="#ä¿®æ”¹é€»è¾‘ç®—å­ç”Ÿæˆå™¨" class="headerlink" title="ä¿®æ”¹é€»è¾‘ç®—å­ç”Ÿæˆå™¨"></a>ä¿®æ”¹é€»è¾‘ç®—å­ç”Ÿæˆå™¨</h4><p>åœ¨é€»è¾‘ç®—å­çš„ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼ŒåŸå§‹çš„ miniob ä¼šå°† Filter ä¸­çš„ field&#x2F;value å˜æˆè¡¨è¾¾å¼ï¼Œå¾ˆæ˜æ˜¾ç°åœ¨è¿™æ˜¯å¤šæ­¤ä¸€ä¸¾ï¼Œå¯¹æ­¤è¿›è¡Œä¿®æ”¹ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ä¸€ä¸ª STMT åˆ›å»ºç®—å­ä¹‹åï¼ŒåŸæ¥çš„å…¨éƒ¨ unique_ptr éƒ½ä¼šè¢«ç§»åŠ¨èµ°ï¼Œåœ¨å­æŸ¥è¯¢é‡Œï¼Œåº”è¯¥è¿˜ä¼šçœ‹åˆ°è¿™å¥è¯ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">RC <span class="hljs-title">LogicalPlanGenerator::create_plan</span><span class="hljs-params">(FilterStmt *filter_stmt, unique_ptr&lt;LogicalOperator&gt; &amp;logical_operator)</span> </span>&#123;<br>  RC rc = RC::SUCCESS;<br>  std::vector&lt;unique_ptr&lt;Expression&gt;&gt; cmp_exprs;<br>  ConjunctionExpr::Type conjunction_types = ConjunctionExpr::Type::AND;<br>  <span class="hljs-type">const</span> std::vector&lt;FilterUnit *&gt; &amp;filter_units = filter_stmt-&gt;<span class="hljs-built_in">filter_units</span>();<br>  <span class="hljs-keyword">for</span> (FilterUnit *filter_unit : filter_units) &#123;<br>    FilterObj &amp;filter_obj_left = filter_unit-&gt;<span class="hljs-built_in">left</span>();<br>    FilterObj &amp;filter_obj_right = filter_unit-&gt;<span class="hljs-built_in">right</span>();<br><br>    unique_ptr&lt;Expression&gt; left = std::<span class="hljs-built_in">move</span>(filter_obj_left.expr);<br>    unique_ptr&lt;Expression&gt; right = std::<span class="hljs-built_in">move</span>(filter_obj_right.expr);<br><br>    <span class="hljs-keyword">if</span> (filter_unit-&gt;<span class="hljs-built_in">conjunction_type</span>() == <span class="hljs-number">1</span>)<br>      conjunction_types = ConjunctionExpr::Type::AND;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (filter_unit-&gt;<span class="hljs-built_in">conjunction_type</span>() == <span class="hljs-number">2</span>)<br>      conjunction_types = ConjunctionExpr::Type::OR;<br><br>    <span class="hljs-type">bool</span> need_value_cast = left-&gt;<span class="hljs-built_in">value_type</span>() != AttrType::TUPLES &amp;&amp; right-&gt;<span class="hljs-built_in">value_type</span>() != AttrType::TUPLES &amp;&amp; left-&gt;<span class="hljs-built_in">type</span>() != ExprType::VALUELIST &amp;&amp;<br>                           right-&gt;<span class="hljs-built_in">type</span>() != ExprType::VALUELIST &amp;&amp; filter_unit-&gt;<span class="hljs-built_in">comp</span>() != CompOp::XXX_IS_NULL &amp;&amp;<br>                           filter_unit-&gt;<span class="hljs-built_in">comp</span>() != CompOp::XXX_IS_NOT_NULL;<br><br>    <span class="hljs-comment">// å¦‚æœå·¦å³ä¸¤è¾¹çš„ç±»å‹ä¸ä¸€è‡´ï¼Œéœ€è¦å…ˆè®¡ç®—è½¬æ¢å¼€é”€ï¼Œå†è¿›è¡Œéšå¼ç±»å‹è½¬æ¢ï¼ŒåŒæ—¶è¦æ’é™¤æœ‰å­æŸ¥è¯¢çš„æƒ…å†µ</span><br>    <span class="hljs-keyword">if</span> (need_value_cast) &#123;<br>      Value left_value, right_value;<br>      left-&gt;<span class="hljs-built_in">try_get_value</span>(left_value);<br>      right-&gt;<span class="hljs-built_in">try_get_value</span>(right_value);<br>      <span class="hljs-keyword">if</span> (!left_value.<span class="hljs-built_in">get_null</span>() &amp;&amp; !right_value.<span class="hljs-built_in">get_null</span>() &amp;&amp; left-&gt;<span class="hljs-built_in">value_type</span>() != right-&gt;<span class="hljs-built_in">value_type</span>()) &#123;<br>        <span class="hljs-keyword">auto</span> left_to_right_cost = <span class="hljs-built_in">implicit_cast_cost</span>(left-&gt;<span class="hljs-built_in">value_type</span>(), right-&gt;<span class="hljs-built_in">value_type</span>());<br>        <span class="hljs-keyword">auto</span> right_to_left_cost = <span class="hljs-built_in">implicit_cast_cost</span>(right-&gt;<span class="hljs-built_in">value_type</span>(), left-&gt;<span class="hljs-built_in">value_type</span>());<br>        <span class="hljs-keyword">if</span> (left_to_right_cost &lt;= right_to_left_cost &amp;&amp; left_to_right_cost != INT32_MAX) &#123;<br>          ExprType left_type = left-&gt;<span class="hljs-built_in">type</span>();<br><br>          <span class="hljs-comment">// ç‰¹æ®Šåˆ¤æ–­ï¼Œå¦‚æœä¸º INTS å’Œ CHARS æ¯”è¾ƒå¤§å°ï¼Œå‡è½¬æ¢æˆ FLOATS ç±»å‹</span><br>          unique_ptr&lt;CastExpr&gt; cast_expr;<br>          <span class="hljs-keyword">if</span> (left-&gt;<span class="hljs-built_in">value_type</span>() == AttrType::CHARS &amp;&amp; right-&gt;<span class="hljs-built_in">value_type</span>() == AttrType::INTS)<br>            cast_expr = <span class="hljs-built_in">make_unique</span>&lt;CastExpr&gt;(std::<span class="hljs-built_in">move</span>(left), AttrType::FLOATS);<br>          <span class="hljs-keyword">else</span><br>            cast_expr = <span class="hljs-built_in">make_unique</span>&lt;CastExpr&gt;(std::<span class="hljs-built_in">move</span>(left), right-&gt;<span class="hljs-built_in">value_type</span>());<br>          <span class="hljs-keyword">if</span> (left_type == ExprType::VALUE) &#123;<br>            Value left_val;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OB_FAIL</span>(rc = cast_expr-&gt;<span class="hljs-built_in">try_get_value</span>(left_val))) &#123;<br>              <span class="hljs-built_in">LOG_WARN</span>(<span class="hljs-string">&quot;failed to get value from left child&quot;</span>, <span class="hljs-built_in">strrc</span>(rc));<br>              <span class="hljs-keyword">return</span> rc;<br>            &#125;<br>            left = <span class="hljs-built_in">make_unique</span>&lt;ValueExpr&gt;(left_val);<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            left = std::<span class="hljs-built_in">move</span>(cast_expr);<br>          &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (right_to_left_cost &lt; left_to_right_cost &amp;&amp; right_to_left_cost != INT32_MAX) &#123;<br>          ExprType right_type = right-&gt;<span class="hljs-built_in">type</span>();<br><br>          <span class="hljs-comment">// ç‰¹æ®Šåˆ¤æ–­ï¼Œå¦‚æœä¸º INTS å’Œ CHARS æ¯”è¾ƒå¤§å°ï¼Œå‡è½¬æ¢æˆ FLOATS ç±»å‹</span><br>          unique_ptr&lt;CastExpr&gt; cast_expr;<br>          <span class="hljs-keyword">if</span> (left-&gt;<span class="hljs-built_in">value_type</span>() == AttrType::INTS &amp;&amp; right-&gt;<span class="hljs-built_in">value_type</span>() == AttrType::CHARS)<br>            cast_expr = <span class="hljs-built_in">make_unique</span>&lt;CastExpr&gt;(std::<span class="hljs-built_in">move</span>(right), AttrType::FLOATS);<br>          <span class="hljs-keyword">else</span><br>            cast_expr = <span class="hljs-built_in">make_unique</span>&lt;CastExpr&gt;(std::<span class="hljs-built_in">move</span>(right), left-&gt;<span class="hljs-built_in">value_type</span>());<br><br>          <span class="hljs-keyword">if</span> (right_type == ExprType::VALUE) &#123;<br>            Value right_val;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OB_FAIL</span>(rc = cast_expr-&gt;<span class="hljs-built_in">try_get_value</span>(right_val))) &#123;<br>              <span class="hljs-built_in">LOG_WARN</span>(<span class="hljs-string">&quot;failed to get value from right child&quot;</span>, <span class="hljs-built_in">strrc</span>(rc));<br>              <span class="hljs-keyword">return</span> rc;<br>            &#125;<br>            right = <span class="hljs-built_in">make_unique</span>&lt;ValueExpr&gt;(right_val);<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            right = std::<span class="hljs-built_in">move</span>(cast_expr);<br>          &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (filter_unit-&gt;<span class="hljs-built_in">comp</span>() == CompOp::LIKE_XXX || filter_unit-&gt;<span class="hljs-built_in">comp</span>() == CompOp::NOT_LIKE_XXX) &#123;<br>          ExprType right_type = right-&gt;<span class="hljs-built_in">type</span>();<br><br>          <span class="hljs-comment">// å¦‚æœæ‰§è¡ŒLIKEè¿ç®—ç¬¦ï¼ŒæŠŠå³è¾¹è½¬åŒ–æˆCHARSç±»å‹</span><br>          unique_ptr&lt;CastExpr&gt; cast_expr;<br>          cast_expr = <span class="hljs-built_in">make_unique</span>&lt;CastExpr&gt;(std::<span class="hljs-built_in">move</span>(right), AttrType::CHARS);<br><br>          <span class="hljs-keyword">if</span> (right_type == ExprType::VALUE) &#123;<br>            Value right_val;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OB_FAIL</span>(rc = cast_expr-&gt;<span class="hljs-built_in">try_get_value</span>(right_val))) &#123;<br>              <span class="hljs-built_in">LOG_WARN</span>(<span class="hljs-string">&quot;failed to get value from right child&quot;</span>, <span class="hljs-built_in">strrc</span>(rc));<br>              <span class="hljs-keyword">return</span> rc;<br>            &#125;<br>            right = <span class="hljs-built_in">make_unique</span>&lt;ValueExpr&gt;(right_val);<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            right = std::<span class="hljs-built_in">move</span>(cast_expr);<br>          &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          rc = RC::UNSUPPORTED;<br>          <span class="hljs-built_in">LOG_WARN</span>(<span class="hljs-string">&quot;unsupported cast from %s to %s&quot;</span>, <span class="hljs-built_in">attr_type_to_string</span>(left-&gt;<span class="hljs-built_in">value_type</span>()), <span class="hljs-built_in">attr_type_to_string</span>(right-&gt;<span class="hljs-built_in">value_type</span>()));<br>          <span class="hljs-keyword">return</span> rc;<br>        &#125;<br>      &#125;<br>    &#125;<br><br>    ComparisonExpr *cmp_expr = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ComparisonExpr</span>(filter_unit-&gt;<span class="hljs-built_in">comp</span>(), std::<span class="hljs-built_in">move</span>(left), std::<span class="hljs-built_in">move</span>(right));<br><br>    cmp_exprs.<span class="hljs-built_in">emplace_back</span>(cmp_expr);<br>  &#125;<br><br>  unique_ptr&lt;PredicateLogicalOperator&gt; predicate_oper;<br>  <span class="hljs-keyword">if</span> (!cmp_exprs.<span class="hljs-built_in">empty</span>()) &#123;<br>    <span class="hljs-function">unique_ptr&lt;ConjunctionExpr&gt; <span class="hljs-title">conjunction_expr</span><span class="hljs-params">(<span class="hljs-keyword">new</span> ConjunctionExpr(conjunction_types, cmp_exprs))</span></span>;<br>    predicate_oper = <span class="hljs-built_in">unique_ptr</span>&lt;PredicateLogicalOperator&gt;(<span class="hljs-keyword">new</span> <span class="hljs-built_in">PredicateLogicalOperator</span>(std::<span class="hljs-built_in">move</span>(conjunction_expr)));<br>  &#125;<br><br>  logical_operator = std::<span class="hljs-built_in">move</span>(predicate_oper);<br>  <span class="hljs-keyword">return</span> rc;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">LogicalPlanGenerator::implicit_cast_cost</span><span class="hljs-params">(AttrType from, AttrType to)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (from == to) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> DataType::<span class="hljs-built_in">type_instance</span>(from)-&gt;<span class="hljs-built_in">cast_cost</span>(to);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="vector-basic"><a href="#vector-basic" class="headerlink" title="vector_basic"></a>vector_basic</h3><p><img src="/img/vector_basic.png"></p><p>ç›¸å¯¹ç®€å•çš„ä¸€é“é¢˜ç›®ï¼Œéœ€è¦æ·»åŠ ä¸€ç§æ•°æ®ç±»å‹ï¼šVECTOR</p><p>æˆ‘ä»¬é‡‡å–çš„æ–¹å¼ä¸ºï¼Œå¯¹äº â€˜[1, 2, 3, 4]â€™ è¿™æ ·çš„å‘é‡ï¼Œå…ˆä»¥å­—ç¬¦ä¸²çš„å½¢å¼è¾“å…¥è¿›æ¥ï¼Œåœ¨ Value çš„æ„é€ å‡½æ•°ä¸­è¿›è¡Œæ ¼å¼æ£€éªŒï¼Œå¦‚æœç¬¦åˆå‘é‡çš„æ ¼å¼ï¼Œé‚£ä¹ˆå°†å…¶è½¬åŒ–ä¸ºå‘é‡å­˜å‚¨ï¼Œå¦åˆ™ä»¥å­—ç¬¦ä¸²çš„æ–¹å¼å­˜å‚¨ã€‚</p><p>æœ‰äº›è¾¹è§’çš„ä¸œè¥¿æ²¡æœ‰ä½“ç°åœ¨ä¸‹é¢çš„æè¿°ä¸­ï¼ŒåŒ…æ‹¬ï¼šæ’å…¥å‘é‡æ—¶çš„é•¿åº¦ä¸åŒ¹é…é—®é¢˜ + åˆ›å»ºè¡¨æ ¼æ—¶çš„ VECTOR é•¿åº¦æ£€éªŒç­‰</p><h4 id="Value-ç±»çš„å®Œå–„"><a href="#Value-ç±»çš„å®Œå–„" class="headerlink" title="Value ç±»çš„å®Œå–„"></a>Value ç±»çš„å®Œå–„</h4><p>é¦–å…ˆï¼Œç”±äºå‘é‡ä¸€å®šæ˜¯ float ç±»å‹ï¼Œæ‰€ä»¥å®é™…çš„å­˜å‚¨å½¢å¼ä¸º vector<float>ã€‚Value ä¸­æœ‰ä¸ªå­—æ®µ lenï¼Œè¡¨ç¤º Value çš„é•¿åº¦ï¼Œæ³¨æ„è¿™ä¸ªé•¿åº¦æ˜¯å ç”¨ç©ºé—´çš„é•¿åº¦ï¼Œå¯¹äº vector æ¥è¯´ï¼Œè¿™ä¸ªé•¿åº¦æ˜¯ vector.size() * 4ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// vector part</span><br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-comment">// åˆ¤æ–­ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ä¸ºå‘é‡å½¢å¼</span><br>  <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">isValidFormat</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *input)</span></span>;<br>  <span class="hljs-comment">// åˆ¤æ–­ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ä¸ºæ•°å­—ï¼Œé¿å… [1, a, 2] è¿™æ ·çš„ä¾‹å­</span><br>  <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">isValidNumber</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string &amp;s)</span></span>;<br>  <span class="hljs-comment">// å°†å­—ç¬¦ä¸²è½¬åŒ–ä¸º vectorï¼Œå¦‚æœå­—ç¬¦ä¸²ä¸åˆæ³•ï¼Œè¿”å› FAILURE</span><br>  <span class="hljs-function"><span class="hljs-type">static</span> RC <span class="hljs-title">string_to_vector</span><span class="hljs-params">(string str, vector&lt;<span class="hljs-type">float</span>&gt; &amp;result)</span></span>;<br><br>  <span class="hljs-comment">// set and get</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">set_vector</span><span class="hljs-params">(std::vector&lt;<span class="hljs-type">float</span>&gt; value_vector)</span></span>;<br>  <span class="hljs-function">vector&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">get_vector</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">get_vector_item</span><span class="hljs-params">(<span class="hljs-type">int</span> idx)</span> <span class="hljs-type">const</span></span>;<br>  <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">get_vector_size</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br><br> <span class="hljs-keyword">private</span>:<br>  std::vector&lt;<span class="hljs-type">float</span>&gt; value_vector_;<br></code></pre></td></tr></table></figure><p>isValidFormat, isValidNumber, string_to_vector çš„è®¾è®¡å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// vector part</span><br><br><span class="hljs-comment">// ç”¨äºæ£€æŸ¥è¾“å…¥å­—ç¬¦ä¸²æ˜¯å¦ç¬¦åˆ vector çš„æ ¼å¼</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Value::isValidFormat</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *input)</span> </span>&#123;<br>  <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦ä¸ºç©ºæˆ–é•¿åº¦å°äº2ï¼ˆå¿…é¡»è‡³å°‘åŒ…å« &quot;[]&quot;)</span><br>  <span class="hljs-keyword">if</span> (input == <span class="hljs-literal">nullptr</span> || <span class="hljs-built_in">strlen</span>(input) &lt; <span class="hljs-number">2</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// æ£€æŸ¥é¦–å°¾æ˜¯å¦åˆ†åˆ«ä¸º &#x27;[&#x27; å’Œ &#x27;]&#x27;</span><br>  <span class="hljs-keyword">if</span> (input[<span class="hljs-number">0</span>] != <span class="hljs-string">&#x27;[&#x27;</span> || input[<span class="hljs-built_in">strlen</span>(input) - <span class="hljs-number">1</span>] != <span class="hljs-string">&#x27;]&#x27;</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// å‰”é™¤ &#x27;[&#x27; å’Œ &#x27;]&#x27;ï¼Œä»ç¬¬äºŒä¸ªå­—ç¬¦å¼€å§‹æ£€æŸ¥</span><br>  <span class="hljs-function">std::string <span class="hljs-title">content</span><span class="hljs-params">(input + <span class="hljs-number">1</span>, strlen(input) - <span class="hljs-number">2</span>)</span></span>;<br><br>  <span class="hljs-comment">// åˆ é™¤å¤šä½™çš„ç©ºæ ¼</span><br>  content.<span class="hljs-built_in">erase</span>(std::<span class="hljs-built_in">remove</span>(content.<span class="hljs-built_in">begin</span>(), content.<span class="hljs-built_in">end</span>(), <span class="hljs-string">&#x27; &#x27;</span>), content.<span class="hljs-built_in">end</span>());<br><br>  <span class="hljs-comment">// ä½¿ç”¨é€—å·åˆ†å‰²å†…å®¹</span><br>  <span class="hljs-function">std::istringstream <span class="hljs-title">ss</span><span class="hljs-params">(content)</span></span>;<br>  std::string token;<br>  std::vector&lt;std::string&gt; tokens;<br><br>  <span class="hljs-comment">// åˆ†å‰²å†…å®¹å¹¶æ£€æŸ¥æ¯ä¸ªéƒ¨åˆ†</span><br>  <span class="hljs-keyword">while</span> (std::<span class="hljs-built_in">getline</span>(ss, token, <span class="hljs-string">&#x27;,&#x27;</span>)) &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isValidNumber</span>(token)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// å¦‚æœæŸä¸ªéƒ¨åˆ†ä¸æ˜¯æœ‰æ•ˆçš„æ•°å­—ï¼Œè¿”å› false</span><br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// æ‰€æœ‰éƒ¨åˆ†éƒ½æ˜¯æœ‰æ•ˆçš„æ•°å­—</span><br>&#125;<br><br><span class="hljs-comment">// ç”¨äºæ£€æŸ¥ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦æ˜¯æ•´æ•°æˆ–æµ®ç‚¹æ•°</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Value::isValidNumber</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string &amp;s)</span> </span>&#123;<br>  <span class="hljs-function">std::istringstream <span class="hljs-title">stream</span><span class="hljs-params">(s)</span></span>;<br>  <span class="hljs-type">float</span> number;<br>  stream &gt;&gt; number;<br>  <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦æˆåŠŸè§£æä¸ºæ•°å­—ï¼Œå¹¶ä¸”æ²¡æœ‰å¤šä½™å­—ç¬¦</span><br>  <span class="hljs-keyword">return</span> stream.<span class="hljs-built_in">eof</span>() &amp;&amp; !stream.<span class="hljs-built_in">fail</span>();<br>&#125;<br><br><span class="hljs-function">RC <span class="hljs-title">Value::string_to_vector</span><span class="hljs-params">(string str, vector&lt;<span class="hljs-type">float</span>&gt; &amp;result)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (!Value::<span class="hljs-built_in">isValidFormat</span>(str.<span class="hljs-built_in">c_str</span>())) <span class="hljs-keyword">return</span> RC::INVALID_ARGUMENT;<br><br>  <span class="hljs-comment">// å‰”é™¤ &#x27;[&#x27; å’Œ &#x27;]&#x27;ï¼Œä»ç¬¬äºŒä¸ªå­—ç¬¦å¼€å§‹æ£€æŸ¥</span><br>  str = str.<span class="hljs-built_in">substr</span>(<span class="hljs-number">1</span>, (<span class="hljs-type">int</span>)str.<span class="hljs-built_in">size</span>() - <span class="hljs-number">2</span>);<br><br>  <span class="hljs-comment">// å»é™¤å¤šä½™ç©ºæ ¼</span><br>  str.<span class="hljs-built_in">erase</span>(std::<span class="hljs-built_in">remove</span>(str.<span class="hljs-built_in">begin</span>(), str.<span class="hljs-built_in">end</span>(), <span class="hljs-string">&#x27; &#x27;</span>), str.<span class="hljs-built_in">end</span>());<br><br>  <span class="hljs-comment">// ä½¿ç”¨é€—å·åˆ†å‰²å†…å®¹</span><br>  <span class="hljs-function">std::istringstream <span class="hljs-title">ss</span><span class="hljs-params">(str)</span></span>;<br>  std::string token;<br>  std::vector&lt;std::string&gt; tokens;<br><br>  <span class="hljs-comment">// åˆ†å‰²å†…å®¹å¹¶æ£€æŸ¥æ¯ä¸ªéƒ¨åˆ†</span><br>  <span class="hljs-keyword">while</span> (std::<span class="hljs-built_in">getline</span>(ss, token, <span class="hljs-string">&#x27;,&#x27;</span>)) &#123;<br>    result.<span class="hljs-built_in">push_back</span>(FloatType::formatFloat(std::<span class="hljs-built_in">stof</span>(token), <span class="hljs-number">2</span>));<br>  &#125;<br>  <span class="hljs-keyword">return</span> RC::SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯ Value è¾“å…¥ä¸ºå­—ç¬¦ä¸²çš„æ„é€ å‡½æ•°ï¼Œå¦‚æœå‘ç°å­—ç¬¦ä¸²çš„æ ¼å¼ä¸ºæ•°ç»„å½¢å¼ï¼Œé‚£ä¹ˆè½¬åŒ–ä¸º VECTORã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs C++">Value::<span class="hljs-built_in">Value</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s, <span class="hljs-type">int</span> len <span class="hljs-comment">/*= 0*/</span>) &#123;<br>  vector&lt;<span class="hljs-type">float</span>&gt; value_vector;<br>  RC rc = Value::<span class="hljs-built_in">string_to_vector</span>(s, value_vector);<br>  <span class="hljs-keyword">if</span> (rc == RC::SUCCESS)<br>    <span class="hljs-built_in">set_vector</span>(value_vector);<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">set_string</span>(s, len);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯ Value å’Œ data çš„è½¬æ¢ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Value::set_data</span><span class="hljs-params">(<span class="hljs-type">char</span> *data, <span class="hljs-type">int</span> length)</span> </span>&#123;<br>  <span class="hljs-keyword">switch</span> (attr_type_) &#123;<br>    <span class="hljs-keyword">case</span> AttrType::CHARS: &#123;<br>      <span class="hljs-built_in">set_string</span>(data, length);<br>    &#125; <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> AttrType::INTS: &#123;<br>      value_.int_value_ = *(<span class="hljs-type">int</span> *)data;<br>      length_ = length;<br>    &#125; <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> AttrType::FLOATS: &#123;<br>      value_.float_value_ = *(<span class="hljs-type">float</span> *)data;<br>      length_ = length;<br>    &#125; <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> AttrType::BOOLEANS: &#123;<br>      value_.bool_value_ = *(<span class="hljs-type">int</span> *)data != <span class="hljs-number">0</span>;<br>      length_ = length;<br>    &#125; <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> AttrType::DATE: &#123;<br>      value_.int_value_ = *(<span class="hljs-type">int</span> *)data;<br>      length_ = length;<br>    &#125; <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> AttrType::VECTORS: &#123;<br>      <span class="hljs-type">size_t</span> element_size = <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">int</span>);<br>      <span class="hljs-type">size_t</span> num_elements = length / element_size;<br><br>      <span class="hljs-comment">// ä½¿ç”¨ memcpy å°†æ•°æ®å¤åˆ¶å› vector</span><br>      value_vector_.<span class="hljs-built_in">resize</span>(num_elements);<br>      <span class="hljs-built_in">memcpy</span>(value_vector_.<span class="hljs-built_in">data</span>(), data, length);<br>      length_ = length;<br>    &#125; <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> AttrType::TEXT: &#123;<br>      <span class="hljs-built_in">set_text</span>(data);<br>    &#125; <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>: &#123;<br>      <span class="hljs-built_in">LOG_WARN</span>(<span class="hljs-string">&quot;unknown data type: %d&quot;</span>, attr_type_);<br>    &#125; <span class="hljs-keyword">break</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title">Value::data</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-keyword">switch</span> (attr_type_) &#123;<br>    <span class="hljs-keyword">case</span> AttrType::TEXT: &#123;<br>      <span class="hljs-keyword">return</span> value_.pointer_value_;<br>    &#125; <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> AttrType::CHARS: &#123;<br>      <span class="hljs-keyword">return</span> value_.pointer_value_;<br>    &#125; <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> AttrType::VECTORS: &#123;<br>      <span class="hljs-keyword">return</span> (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)(value_vector_.<span class="hljs-built_in">data</span>());<br>    &#125;<br>    <span class="hljs-keyword">default</span>: &#123;<br>      <span class="hljs-keyword">return</span> (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)&amp;value_;<br>    &#125; <span class="hljs-keyword">break</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="VECTOR-çš„å„ç§è¿ç®—"><a href="#VECTOR-çš„å„ç§è¿ç®—" class="headerlink" title="VECTOR çš„å„ç§è¿ç®—"></a>VECTOR çš„å„ç§è¿ç®—</h4><p>åœ¨ common&#x2F;type ä¸­ï¼Œè¿˜éœ€è¦å®Œæˆæœ‰å…³ VECTOR çš„å„ç§è®¡ç®—ã€æ¯”è¾ƒç­‰ã€‚ç”±äºæ¯”è¾ƒç®€å•è¿™é‡Œç›´æ¥æ”¾ä¸Šæ¥äº†ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¯”èµ›è¦æ±‚å‘é‡çš„ä¹˜æ³•æ˜¯é€ä½ç›¸ä¹˜ï¼Œä¹Ÿå³ä¸¤ä¸ªå‘é‡çš„ä¹˜ç§¯ä»ä¸ºå‘é‡ï¼š[1, 2, 3] * [4, 5, 6] &#x3D; [4, 10, 18]ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">VectorType::compare</span><span class="hljs-params">(<span class="hljs-type">const</span> Value &amp;left, <span class="hljs-type">const</span> Value &amp;right)</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (left.<span class="hljs-built_in">attr_type</span>() != AttrType::VECTORS || right.<span class="hljs-built_in">attr_type</span>() != AttrType::VECTORS || left.<span class="hljs-built_in">get_vector_size</span>() != right.<span class="hljs-built_in">get_vector_size</span>())<br>    <span class="hljs-keyword">return</span> INT32_MAX;<br>  <span class="hljs-type">int</span> size = (<span class="hljs-type">int</span>)left.<span class="hljs-built_in">get_vector_size</span>();<br>  <span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++) &#123;<br>    <span class="hljs-keyword">if</span> (left.<span class="hljs-built_in">get_vector</span>()[i] &gt; right.<span class="hljs-built_in">get_vector</span>()[i]) &#123;<br>      result = <span class="hljs-number">1</span>;<br>      <span class="hljs-keyword">break</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (left.<span class="hljs-built_in">get_vector</span>()[i] &lt; right.<span class="hljs-built_in">get_vector</span>()[i]) &#123;<br>      result = <span class="hljs-number">-1</span>;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-function">RC <span class="hljs-title">VectorType::add</span><span class="hljs-params">(<span class="hljs-type">const</span> Value &amp;left, <span class="hljs-type">const</span> Value &amp;right, Value &amp;result)</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (left.<span class="hljs-built_in">attr_type</span>() != AttrType::VECTORS || right.<span class="hljs-built_in">attr_type</span>() != AttrType::VECTORS || left.<span class="hljs-built_in">get_vector_size</span>() != right.<span class="hljs-built_in">get_vector_size</span>())<br>    <span class="hljs-keyword">return</span> RC::INVALID_ARGUMENT;<br>  <span class="hljs-type">int</span> size = (<span class="hljs-type">int</span>)left.<span class="hljs-built_in">get_vector_size</span>();<br>  <span class="hljs-function">vector&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">answer</span><span class="hljs-params">(size, <span class="hljs-number">0</span>)</span></span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++) answer[i] = left.<span class="hljs-built_in">get_vector</span>()[i] + right.<span class="hljs-built_in">get_vector</span>()[i];<br>  result.<span class="hljs-built_in">set_vector</span>(answer);<br>  <span class="hljs-keyword">return</span> RC::SUCCESS;<br>&#125;<br><span class="hljs-function">RC <span class="hljs-title">VectorType::subtract</span><span class="hljs-params">(<span class="hljs-type">const</span> Value &amp;left, <span class="hljs-type">const</span> Value &amp;right, Value &amp;result)</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (left.<span class="hljs-built_in">attr_type</span>() != AttrType::VECTORS || right.<span class="hljs-built_in">attr_type</span>() != AttrType::VECTORS || left.<span class="hljs-built_in">get_vector_size</span>() != right.<span class="hljs-built_in">get_vector_size</span>())<br>    <span class="hljs-keyword">return</span> RC::INVALID_ARGUMENT;<br>  <span class="hljs-type">int</span> size = (<span class="hljs-type">int</span>)left.<span class="hljs-built_in">get_vector_size</span>();<br>  <span class="hljs-function">vector&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">answer</span><span class="hljs-params">(size, <span class="hljs-number">0</span>)</span></span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++) answer[i] = left.<span class="hljs-built_in">get_vector</span>()[i] - right.<span class="hljs-built_in">get_vector</span>()[i];<br>  result.<span class="hljs-built_in">set_vector</span>(answer);<br>  <span class="hljs-keyword">return</span> RC::SUCCESS;<br>&#125;<br><span class="hljs-function">RC <span class="hljs-title">VectorType::multiply</span><span class="hljs-params">(<span class="hljs-type">const</span> Value &amp;left, <span class="hljs-type">const</span> Value &amp;right, Value &amp;result)</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (left.<span class="hljs-built_in">attr_type</span>() != AttrType::VECTORS || right.<span class="hljs-built_in">attr_type</span>() != AttrType::VECTORS || left.<span class="hljs-built_in">get_vector_size</span>() != right.<span class="hljs-built_in">get_vector_size</span>())<br>    <span class="hljs-keyword">return</span> RC::INVALID_ARGUMENT;<br>  <span class="hljs-type">int</span> size = (<span class="hljs-type">int</span>)left.<span class="hljs-built_in">get_vector_size</span>();<br>  <span class="hljs-function">vector&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">answer</span><span class="hljs-params">(size, <span class="hljs-number">0</span>)</span></span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++) answer[i] = left.<span class="hljs-built_in">get_vector</span>()[i] * right.<span class="hljs-built_in">get_vector</span>()[i];<br>  result.<span class="hljs-built_in">set_vector</span>(answer);<br>  <span class="hljs-keyword">return</span> RC::SUCCESS;<br>&#125;<br><br><span class="hljs-function">RC <span class="hljs-title">VectorType::to_string</span><span class="hljs-params">(<span class="hljs-type">const</span> Value &amp;val, string &amp;result)</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (val.<span class="hljs-built_in">attr_type</span>() != AttrType::VECTORS) <span class="hljs-keyword">return</span> RC::INVALID_ARGUMENT;<br><br>  result = <span class="hljs-string">&quot;[&quot;</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it : val.<span class="hljs-built_in">get_vector</span>()) &#123;<br>    it = FloatType::formatFloat(it, <span class="hljs-number">2</span>);<br>    string str = std::<span class="hljs-built_in">to_string</span>(it);<br>    str = FloatType::formatFloat_s(it, <span class="hljs-number">2</span>);<br><br>    <span class="hljs-comment">// å»é™¤åå¯¼é›¶</span><br>    str.<span class="hljs-built_in">erase</span>(str.<span class="hljs-built_in">find_last_not_of</span>(<span class="hljs-string">&#x27;0&#x27;</span>) + <span class="hljs-number">1</span>, std::string::npos);<br>    <span class="hljs-keyword">if</span> (str.<span class="hljs-built_in">back</span>() == <span class="hljs-string">&#x27;.&#x27;</span>) &#123;<br>      str.<span class="hljs-built_in">pop_back</span>();<br>    &#125;<br>    result += str;<br>    result += <span class="hljs-string">&#x27;,&#x27;</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">int</span>)result.<span class="hljs-built_in">length</span>() &gt; <span class="hljs-number">1</span>) result.<span class="hljs-built_in">pop_back</span>();<br>  result += <span class="hljs-string">&quot;]&quot;</span>;<br><br>  <span class="hljs-keyword">return</span> RC::SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="vector-format"><a href="#vector-format" class="headerlink" title="vector_format"></a>vector_format</h3><p><img src="/img/vector_format.png"></p><p>é¢˜ç›®è¦æ±‚ä¸ä»…è¦è¯†åˆ«å­—ç¬¦ä¸²ç±»å‹çš„å‘é‡æ•°æ®ï¼Œè¿˜éœ€è¦è¯†åˆ«ä¸å¸¦å¼•å·çš„å‘é‡æ•°æ®ã€‚æˆ‘åœ¨å†™çš„æ—¶å€™å·æ‡’äº†ï¼Œç›´æ¥é‡‡å– [ + value + value_list + ]ï¼Œæ‰€ä»¥åªéœ€è¦åœ¨ yacc ä¸­æ·»åŠ è¿™ä¸€æ¡è§„åˆ™å³å¯ã€‚</p><h4 id="lex-å’Œ-yacc-å®Œå–„"><a href="#lex-å’Œ-yacc-å®Œå–„" class="headerlink" title="lex å’Œ yacc å®Œå–„"></a>lex å’Œ yacc å®Œå–„</h4><p>lex éœ€è¦æ·»åŠ å·¦å³ä¸­æ‹¬å·çš„è¯è¯­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-string">&quot;[&quot;</span>                                     <span class="hljs-built_in">RETURN_TOKEN</span>(LBRACKET);<br><span class="hljs-string">&quot;]&quot;</span>                                     <span class="hljs-built_in">RETURN_TOKEN</span>(RBRACKET);<br></code></pre></td></tr></table></figure><p>yacc éœ€è¦æ·»åŠ å¯¹å‘é‡å˜é‡çš„è¯†åˆ«ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs C++">value:<br>    LBRACKET value value_list RBRACKET &#123;<br>      std::vector&lt;<span class="hljs-type">float</span>&gt; nums;<br>      nums.<span class="hljs-built_in">emplace_back</span>($<span class="hljs-number">2</span>-&gt;<span class="hljs-built_in">get_float</span>());<br>      <span class="hljs-keyword">if</span>($<span class="hljs-number">3</span> != <span class="hljs-literal">nullptr</span>) &#123;<br>        std::<span class="hljs-built_in">reverse</span>($<span class="hljs-number">3</span>-&gt;<span class="hljs-built_in">begin</span>(), $<span class="hljs-number">3</span>-&gt;<span class="hljs-built_in">end</span>());<br>        <span class="hljs-keyword">for</span> (Value value : *$<span class="hljs-number">3</span>) &#123;<br>          nums.<span class="hljs-built_in">emplace_back</span>(value.<span class="hljs-built_in">get_float</span>());<br>        &#125;<br>      &#125;<br>      $$ = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Value</span>(nums);<br>    &#125;<br></code></pre></td></tr></table></figure><h3 id="join-tables"><a href="#join-tables" class="headerlink" title="join-tables"></a>join-tables</h3><p><img src="/img/join_tables.png"></p><p>join-tables æ‰€æ¶‰åŠçš„ç®—å­åœ¨åˆå§‹å·¥ç¨‹å·²ç»å¾ˆå®Œå–„äº†ã€‚ç®€å•æ¥è¯´ï¼Œå¯¹äºä¸€æ¡ select è¯­å¥å¯èƒ½æœ‰å¤šä¸ªç›®æ ‡è¡¨æ ¼ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªç›®æ ‡è¡¨æ ¼ä¸ºä¸»è¡¨æ ¼ï¼Œåé¢çš„è¡¨æ ¼ä¼šè·Ÿä¸»è¡¨æ ¼ä¸€å¹¶åšç¬›å¡å°”ç§¯ã€‚åˆ›å»ºç®—å­çš„æ—¶å€™ï¼Œç¬¬ä¸€ä¸ªè¡¨æ ¼ä¼šåˆ›å»º TableGet ç›¸å…³ç®—å­ï¼Œåé¢çš„è¡¨æ ¼ä¼šåˆ›å»º JoinTable ç›¸å…³ç®—å­ã€‚</p><p>å¯¹äº INNERJOINï¼ŒON ä¸­å®šä¹‰çš„è°“è¯é€»è¾‘å’Œ WHERE ä¸­å®šä¹‰çš„è°“è¯é€»è¾‘æ˜¯å®Œå…¨å¹³ç­‰çš„ï¼Œæ‰€ä»¥ï¼Œå¯¹äº ON ä¸­çš„å…¨éƒ¨è°“è¯é€»è¾‘ï¼Œæˆ‘ä»¬åªéœ€è¦å°†å…¶è§†ä½œ WHERE ä¸­é€šè¿‡ AND è¿ç»“è¯è¿åœ¨ä¸€èµ·çš„å³å¯ã€‚</p><p>å¯¹äº join éƒ¨åˆ†ï¼Œå°†å…¶è§†ä½œä¸€ä¸ªè¡¨è¾¾å¼ï¼ŒåŸå› è§ expressionã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// *********************************************************</span><br><span class="hljs-comment">// * è¡¨æ ¼è¿æ¥è¡¨è¾¾å¼</span><br><span class="hljs-comment">// *</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">JoinTableExpr</span> : <span class="hljs-keyword">public</span> Expression &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">JoinTableExpr</span>(std::vector&lt;ConditionSqlNode&gt; conditions, unique_ptr&lt;Expression&gt; child) : <span class="hljs-built_in">conditions_</span>(conditions), <span class="hljs-built_in">child_</span>(std::<span class="hljs-built_in">move</span>(child)) &#123;&#125;<br>  <span class="hljs-built_in">JoinTableExpr</span>(std::vector&lt;ConditionSqlNode&gt; conditions, Expression *child) : <span class="hljs-built_in">conditions_</span>(conditions), <span class="hljs-built_in">child_</span>(child) &#123;&#125;<br><br>  <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">JoinTableExpr</span>() = <span class="hljs-keyword">default</span>;<br><br>  <span class="hljs-function">ExprType <span class="hljs-title">type</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>&#123; <span class="hljs-keyword">return</span> ExprType::JOINTABLE; &#125;<br>  <span class="hljs-function">AttrType <span class="hljs-title">value_type</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>&#123; <span class="hljs-keyword">return</span> AttrType::UNDEFINED; &#125;<br><br>  <span class="hljs-function">RC <span class="hljs-title">get_value</span><span class="hljs-params">(<span class="hljs-type">const</span> Tuple &amp;tuple, Value &amp;value)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>&#123; <span class="hljs-keyword">return</span> RC::INTERNAL; &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">const</span> std::vector&lt;ConditionSqlNode&gt; <span class="hljs-title">conditions</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> conditions_; &#125;<br>  <span class="hljs-function"><span class="hljs-type">const</span> std::unique_ptr&lt;Expression&gt; &amp;<span class="hljs-title">child</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> child_; &#125;<br><br> <span class="hljs-keyword">private</span>:<br>  std::vector&lt;ConditionSqlNode&gt; conditions_;<br>  std::unique_ptr&lt;Expression&gt; child_;<br>&#125;;<br></code></pre></td></tr></table></figure><h4 id="lex-å’Œ-yacc-çš„å®Œå–„"><a href="#lex-å’Œ-yacc-çš„å®Œå–„" class="headerlink" title="lex å’Œ yacc çš„å®Œå–„"></a>lex å’Œ yacc çš„å®Œå–„</h4><p>lex éœ€è¦å®Œå–„å¯¹ JOIN&#x2F;INNER JOIN&#x2F;ON çš„è¯†åˆ«ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C++">JOIN|INNER[ \t]+<span class="hljs-function">JOIN                    <span class="hljs-title">RETURN_TOKEN</span><span class="hljs-params">(INNER_JOIN)</span></span>;<br><span class="hljs-function">ON                                      <span class="hljs-title">RETURN_TOKEN</span><span class="hljs-params">(ON)</span></span>;<br></code></pre></td></tr></table></figure><p>å¯¹äº join å­å¥çš„éƒ¨åˆ†ï¼Œåˆ›å»ºä¸€ä¸ª expression æ•°ç»„ï¼Œæ•°ç»„çš„ expression ç±»å‹ä¸º JoinTableExprï¼Œæ¯ä¸€ä¸ª JoinTableExpr åŒ…å« join çš„è¡¨æ ¼ä»¥åŠè°“è¯é€»è¾‘è¯­å¥ã€‚</p><p>select_stmt ä¹Ÿéœ€è¦åŠ å…¥ join_list éƒ¨åˆ†ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs C++">join_list:<br>    <span class="hljs-comment">/* empty */</span><br>    &#123;<br>      $$ = <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    | INNER_JOIN relation ON condition_list join_list &#123;<br>      <span class="hljs-keyword">if</span> ($<span class="hljs-number">5</span> != <span class="hljs-literal">nullptr</span>) &#123;<br>        $$ = $<span class="hljs-number">5</span>;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        $$ = <span class="hljs-keyword">new</span> std::vector&lt;std::unique_ptr&lt;Expression&gt;&gt;;<br>      &#125;<br>      $$-&gt;<span class="hljs-built_in">emplace_back</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">JoinTableExpr</span>(*$<span class="hljs-number">4</span>, $<span class="hljs-number">2</span>));<br>    &#125;<br>    ;<br></code></pre></td></tr></table></figure><h4 id="select-stmt-çš„å®Œå–„"><a href="#select-stmt-çš„å®Œå–„" class="headerlink" title="select_stmt çš„å®Œå–„"></a>select_stmt çš„å®Œå–„</h4><p>åœ¨åˆ›å»º SelectStmt æ—¶ï¼Œéœ€è¦å°† join çš„è¡¨æ ¼å’Œè°“è¯è¯­å¥æ·»åŠ åˆ° select è¯­å¥ä¸­çš„è¡¨æ ¼åˆ—è¡¨å’Œè°“è¯è¯­å¥åˆ—è¡¨ä¸­ã€‚è°“è¯è¯­å¥é¡ºåºæ— æ‰€è°“ï¼Œä½†æ˜¯è¡¨æ ¼çš„é¡ºåºä¼šå½±å“è¾“å‡ºè¡¨å¤´çš„é¡ºåºï¼Œæ‰€ä»¥éœ€è¦ä¸¥æ ¼æŒ‰ç…§ JOIN å‡ºç°çš„é¡ºåºã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// *****************************************************************************</span><br>  <span class="hljs-comment">// * å°†èŠ‚ç‚¹ä¸­çš„ join æ·»åŠ åˆ° conditions ä»¥åŠ relations å½“ä¸­</span><br>  <span class="hljs-comment">// *    åœ¨ä¹‹åçš„å¤„ç†ä¸­ï¼Œå¦‚æœæŸ¥è¯¢çš„è¡¨æ ¼æœ‰å¤šä¸ªï¼Œå°±ä¼šè®¡ç®—å…¨éƒ¨è¡¨æ ¼çš„ç¬›å¡å°”ç§¯</span><br>  <span class="hljs-comment">// *    join ç­‰ä»·äºå…ˆæ±‚ç¬›å¡å°”ç§¯ï¼Œç„¶åè¿›è¡Œé€‰æ‹©è¿ç®—</span><br>  <span class="hljs-comment">// *    æ‰€ä»¥éœ€è¦å°†é€‰æ‹©æ¡ä»¶ä¹ŸåŠ è¿› conditions ä¸­(ç›®å‰å…¨æ˜¯ AND è¿ç®—ï¼Œæ‰€ä»¥å¯ä»¥è¿™ä¹ˆå¤„ç†)</span><br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; select_sql.join.<span class="hljs-built_in">size</span>(); i++) &#123;<br>    JoinTableExpr *join_table_expr = <span class="hljs-built_in">static_cast</span>&lt;JoinTableExpr *&gt;(select_sql.join[i].<span class="hljs-built_in">get</span>());<br>    UnboundTableExpr *table_expr = <span class="hljs-built_in">static_cast</span>&lt;UnboundTableExpr *&gt;(join_table_expr-&gt;<span class="hljs-built_in">child</span>().<span class="hljs-built_in">get</span>());<br>    unique_ptr&lt;Expression&gt; temp = <span class="hljs-built_in">make_unique</span>&lt;UnboundTableExpr&gt;(table_expr-&gt;<span class="hljs-built_in">table_name</span>(), table_expr-&gt;<span class="hljs-built_in">table_alias</span>());<br>    select_sql.relations.<span class="hljs-built_in">emplace_back</span>(<span class="hljs-built_in">move</span>(temp));<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> condition : join_table_expr-&gt;<span class="hljs-built_in">conditions</span>()) select_sql.conditions.<span class="hljs-built_in">emplace_back</span>(condition);<br>  &#125;<br></code></pre></td></tr></table></figure><h3 id="null"><a href="#null" class="headerlink" title="null"></a>null</h3><p><img src="/img/null.png"></p><p>é¢˜ç›®è¦æ±‚æ”¯æŒä¸€ç§ç‰¹æ®Šçš„æ•°æ®ç±»å‹ï¼šnullï¼Œå®ƒä¸å±äºä»»ä½•æ™®é€šç±»å‹ï¼Œå´åˆèƒ½åŒ¹é…ä»»ä½•æ™®é€šç±»å‹ã€‚</p><p>æ•´ä½“æ¥è¯´ï¼Œéœ€è¦å®Œæˆä»¥ä¸‹å†…å®¹ï¼š</p><ol><li>æ”¯æŒè¯†åˆ«å…³é”®å­— NULL IS NOT ç­‰</li><li>æ”¯æŒåˆ›å»ºè¡¨æ ¼æ—¶å¯¹ç‰¹å®šåŸŸå£°æ˜ NULL or NOT NULL &#x3D; default</li><li>Value ç±»ä¸­æ·»åŠ å¯¹ NULL çš„ç®¡ç†</li><li>æ”¯æŒæ’å…¥æ•°æ®æ—¶æ’å…¥ NULLï¼Œå¹¶åˆ¤æ–­åˆæ³•æ€§</li><li>æ”¯æŒæ›´æ–°æ•°æ®æ—¶æ›´æ–° NULLï¼Œå¹¶åˆ¤æ–­åˆæ³•æ€§</li><li>æ”¯æŒè°“è¯é€»è¾‘æ™®é€šè¿ç®—ç¬¦å¯¹ NULL è®¡ç®—ï¼Œä»¥åŠè°“è¯é€»è¾‘æ–°å¢è¿ç®— IS NULL and IS NOT NULL</li></ol><p>é¢å¤–éœ€è¦è€ƒè™‘çš„ä¸€ç‚¹ä¸ºï¼ŒValue ä¼šè¢«è½¬æ¢æˆ Record å†™å…¥å†…å­˜ï¼Œä¹Ÿå³å®é™…å†™å…¥å†…å­˜çš„æ˜¯ 01 ä¸²ï¼Œè€Œé€šè¿‡ 01 ä¸²å¹¶ä¸èƒ½çŸ¥é“è¿™æ˜¯ä»€ä¹ˆç±»å‹ã€‚å‡è®¾æŸä¸ªåŸŸç±»å‹ä¸º INTï¼Œå®ƒå¯ä»¥é€šè¿‡è¡¨å¤´ä¿¡æ¯çŸ¥é“ï¼šä»è¯¥åˆ—æ‹¿å‡ºæ¥çš„æ•°æ®ä¸€å®šæ˜¯ INT ç±»å‹ï¼Œæ‰€ä»¥å¯ä»¥å°† 01 ä¸²æŒ‰ç…§ INT çš„å­˜å‚¨è§„åˆ™è¿˜åŸï¼Œä½†æ˜¯å¯¹äº NULL ç±»å‹ï¼Œç”±äºå…¶å¯ä»¥åŒ¹é…ä»»æ„ç±»å‹ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½é€šè¿‡æŸå¤„è®°å½•çš„ä¿¡æ¯æ¥å¾—çŸ¥æ‹¿å‡ºæ¥çš„æ•°æ®ä¸º NULL ç±»å‹ã€‚</p><p>æˆ‘ä»¬çš„å¤„ç†æ˜¯ bitmap æˆ–è€… å†™å…¥ç‰¹æ®Šå­—ç¬¦ï¼Œä½¿ç”¨ bitmap ä¼šå¯¼è‡´åé¢çš„å¹¶å‘ update æŠ¥é”™ï¼Œè‡³æ¯”èµ›ç»“æŸä»ä¸çŸ¥é“åŸå› ã€‚ä¸è¿‡ bitmap æ— ç–‘æ˜¯æœ€ä¼˜ç¾çš„è§£å†³æ–¹æ¡ˆã€‚</p><blockquote><p>â€”- WARING  ä¸‹æ–‡æœ‰ç‹—å± â€”-</p></blockquote><p>æ‰€ä»¥æˆ‘ä»¬çš„å¤„ç†æ–¹æ³•æ˜¯ï¼Œå¯¹äºä¸€ä¸ª x å­—èŠ‚çš„æ•°æ®ï¼Œå¦‚æœå®ƒçš„ç±»å‹ä¸º NULLï¼Œåˆ™å‘å†…å­˜å†™å…¥æ•°æ®æ—¶ï¼Œå†™å…¥ x å­—èŠ‚çš„ Ã¿ï¼Œå°±æ˜¯å¦‚æ­¤æŠ½è±¡ã€‚æ‹¿å‡ºæ•°æ®æ—¶ï¼Œé¦–å…ˆæ£€éªŒ 01 ä¸²æ˜¯å¦ä¸º x å­—èŠ‚çš„ Ã¿ çš„ ASCII ç ï¼Œ<br>å¦‚æœæ˜¯åˆ™è¿˜åŸæˆ NULLï¼Œä¸æ˜¯åˆ™æ ¹æ®è¡¨å¤´ä¿¡æ¯ç­‰è¿˜åŸã€‚</p><h4 id="æ”¯æŒè¯†åˆ«å…³é”®å­—-NULL-IS-NOT-ç­‰"><a href="#æ”¯æŒè¯†åˆ«å…³é”®å­—-NULL-IS-NOT-ç­‰" class="headerlink" title="æ”¯æŒè¯†åˆ«å…³é”®å­— NULL IS NOT ç­‰"></a>æ”¯æŒè¯†åˆ«å…³é”®å­— NULL IS NOT ç­‰</h4><p>lex ä¸­éœ€è¦æ·»åŠ æ–°çš„è¯è¯­è§£æ</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scss">NULL                                    <span class="hljs-built_in">RETURN_TOKEN</span>(NULLABLE);<br>NOT<span class="hljs-selector-attr">[ \t]</span>+NULL                           <span class="hljs-built_in">RETURN_TOKEN</span>(UNNULLABLE);<br>IS<span class="hljs-selector-attr">[ \t]</span>+NULL                            <span class="hljs-built_in">RETURN_TOKEN</span>(IS_NULL);<br>IS<span class="hljs-selector-attr">[ \t]</span>+NOT+<span class="hljs-selector-attr">[ \t]</span>+NULL                  <span class="hljs-built_in">RETURN_TOKEN</span>(IS_NOT_NULL);<br></code></pre></td></tr></table></figure><h4 id="æ”¯æŒåˆ›å»ºè¡¨æ ¼æ—¶å¯¹ç‰¹å®šåŸŸå£°æ˜-NULL-or-NOT-NULL-default"><a href="#æ”¯æŒåˆ›å»ºè¡¨æ ¼æ—¶å¯¹ç‰¹å®šåŸŸå£°æ˜-NULL-or-NOT-NULL-default" class="headerlink" title="æ”¯æŒåˆ›å»ºè¡¨æ ¼æ—¶å¯¹ç‰¹å®šåŸŸå£°æ˜ NULL or NOT NULL &#x3D; default"></a>æ”¯æŒåˆ›å»ºè¡¨æ ¼æ—¶å¯¹ç‰¹å®šåŸŸå£°æ˜ NULL or NOT NULL &#x3D; default</h4><p>yacc ä¸­éœ€è¦æ·»åŠ æ–°çš„è¯­æ³•è§£æ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// è¿ç®—ç¬¦</span><br>comp_op:<br>    ...<br>    | IS_NULL &#123; $$ = XXX_IS_NULL; &#125;<br>    | IS_NOT_NULL &#123; $$ = XXX_IS_NOT_NULL; &#125;<br>    | NOT_LIKE &#123; $$ = NOT_LIKE_XXX; &#125;<br>    ...<br>    ;<br><span class="hljs-comment">// åˆ›å»ºè¡¨æ ¼æ—¶çš„å£°æ˜</span><br>attr_def:<br>    ID type LBRACE number RBRACE null_def <br>    &#123;<br>      $$ = <span class="hljs-keyword">new</span> AttrInfoSqlNode;<br>      $$-&gt;type = (AttrType)$<span class="hljs-number">2</span>;<br>      $$-&gt;name = $<span class="hljs-number">1</span>;<br>      $$-&gt;length = $<span class="hljs-number">4</span>;<br>      $$-&gt;can_be_null = $<span class="hljs-number">6</span>;<br><br>      ...<br><br>      <span class="hljs-built_in">free</span>($<span class="hljs-number">1</span>);<br>    &#125;<br><span class="hljs-comment">// null</span><br>null_def:<br>    &#123;<br>      $$ = <span class="hljs-literal">false</span>;<br>    &#125;<br>    | NULLABLE &#123;<br>      $$ = <span class="hljs-literal">true</span>;<br>    &#125;<br>    | UNNULLABLE &#123;<br>      $$ = <span class="hljs-literal">false</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="Value-ç±»ä¸­æ·»åŠ å¯¹-NULL-çš„ç®¡ç†"><a href="#Value-ç±»ä¸­æ·»åŠ å¯¹-NULL-çš„ç®¡ç†" class="headerlink" title="Value ç±»ä¸­æ·»åŠ å¯¹ NULL çš„ç®¡ç†"></a>Value ç±»ä¸­æ·»åŠ å¯¹ NULL çš„ç®¡ç†</h4><p>Value ä¸­æ·»åŠ æ ‡å¿—ä½ is_null_ï¼Œç”¨äºåˆ¤æ–­ Value æ˜¯å¦ä¸º NULLã€‚åŒæ—¶è¿˜éœ€è¦ç»´æŠ¤å„ç§æ„é€ å‡½æ•°ï¼Œæ‹·è´å‡½æ•°ï¼Œè¿ç®—ç¬¦é‡è½½æœ‰å…³ NULL çš„é—®é¢˜ã€‚åŒæ—¶ NULL æ•°æ®è½¬åŒ–ä¸º char * å†™å…¥å†…å­˜çš„<br>æ—¶å€™è¦è½¬æ¢æˆè‹¥å¹²ä¸ª Ã¿ã€‚</p><h4 id="æ”¯æŒæ’å…¥æ•°æ®æ—¶æ’å…¥-NULLï¼Œå¹¶åˆ¤æ–­åˆæ³•æ€§"><a href="#æ”¯æŒæ’å…¥æ•°æ®æ—¶æ’å…¥-NULLï¼Œå¹¶åˆ¤æ–­åˆæ³•æ€§" class="headerlink" title="æ”¯æŒæ’å…¥æ•°æ®æ—¶æ’å…¥ NULLï¼Œå¹¶åˆ¤æ–­åˆæ³•æ€§"></a>æ”¯æŒæ’å…¥æ•°æ®æ—¶æ’å…¥ NULLï¼Œå¹¶åˆ¤æ–­åˆæ³•æ€§</h4><p>åœ¨å°† Value è½¬åŒ–ä¸º Record æ—¶ï¼Œéœ€è¦é¢å¤–åšä¸€æ­¥åˆ¤æ–­ã€‚å¦‚æœæ’å…¥çš„æ•°æ®ä¸º NULL ä¸”è¯¥åŸŸä¸å…è®¸ä¸º NULLï¼Œè¿”å› FAILUREã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">RC <span class="hljs-title">Table::make_record</span><span class="hljs-params">(<span class="hljs-type">int</span> value_num, <span class="hljs-type">const</span> Value *values, Record &amp;record)</span> </span>&#123;<br>  RC rc = RC::SUCCESS;<br>  <span class="hljs-comment">// æ£€æŸ¥å±æ€§æ•°é‡æ˜¯å¦ä¸€è‡´</span><br>  <span class="hljs-keyword">if</span> (value_num + table_meta_.<span class="hljs-built_in">sys_field_num</span>() != table_meta_.<span class="hljs-built_in">field_num</span>()) &#123;<br>    <span class="hljs-built_in">LOG_WARN</span>(<span class="hljs-string">&quot;Input values don&#x27;t match the table&#x27;s schema, table name:%s&quot;</span>, table_meta_.<span class="hljs-built_in">name</span>());<br>    <span class="hljs-keyword">return</span> RC::SCHEMA_FIELD_MISSING;<br>  &#125;<br><br>  <span class="hljs-type">const</span> <span class="hljs-type">int</span> normal_field_start_index = table_meta_.<span class="hljs-built_in">sys_field_num</span>();<br>  <span class="hljs-comment">// å¤åˆ¶æ‰€æœ‰å­—æ®µçš„å€¼</span><br>  <span class="hljs-type">int</span> record_size = table_meta_.<span class="hljs-built_in">record_size</span>();<br>  <span class="hljs-type">char</span> *record_data = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(record_size);<br>  <span class="hljs-built_in">memset</span>(record_data, <span class="hljs-number">0</span>, record_size);<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; value_num &amp;&amp; <span class="hljs-built_in">OB_SUCC</span>(rc); i++) &#123;<br>    <span class="hljs-type">const</span> FieldMeta *field = table_meta_.<span class="hljs-built_in">field</span>(i + normal_field_start_index);<br>    Value value = values[i];<br><br>    <span class="hljs-comment">// å½“æ’å…¥æ•°æ® NULL æ—¶ï¼Œåšä¸€æ¬¡æ£€éªŒ</span><br>    <span class="hljs-keyword">if</span> (value.<span class="hljs-built_in">get_null</span>()) &#123;<br>      <span class="hljs-keyword">if</span> (field-&gt;<span class="hljs-built_in">can_be_null</span>() == <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-built_in">LOG_WARN</span>(<span class="hljs-string">&quot;failed to insert NULL to NOT_NULL field&quot;</span>);<br>        <span class="hljs-keyword">return</span> RC::INVALID_ARGUMENT;<br>      &#125;<br>      rc = <span class="hljs-built_in">set_value_to_record</span>(record_data, value, field, i);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (field-&gt;<span class="hljs-built_in">type</span>() != value.<span class="hljs-built_in">attr_type</span>()) &#123;<br>      Value real_value;<br>      rc = Value::<span class="hljs-built_in">cast_to</span>(value, field-&gt;<span class="hljs-built_in">type</span>(), real_value);<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OB_FAIL</span>(rc)) &#123;<br>        <span class="hljs-built_in">LOG_WARN</span>(<span class="hljs-string">&quot;failed to cast value. table name:%s,field name:%s,value:%s &quot;</span>, table_meta_.<span class="hljs-built_in">name</span>(), field-&gt;<span class="hljs-built_in">name</span>(), value.<span class="hljs-built_in">to_string</span>().<span class="hljs-built_in">c_str</span>());<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>      rc = <span class="hljs-built_in">set_value_to_record</span>(record_data, real_value, field, i);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      rc = <span class="hljs-built_in">set_value_to_record</span>(record_data, value, field, i);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OB_FAIL</span>(rc)) &#123;<br>    <span class="hljs-built_in">LOG_WARN</span>(<span class="hljs-string">&quot;failed to make record. table name:%s&quot;</span>, table_meta_.<span class="hljs-built_in">name</span>());<br>    <span class="hljs-built_in">free</span>(record_data);<br>    <span class="hljs-keyword">return</span> rc;<br>  &#125;<br><br>  record.<span class="hljs-built_in">set_data_owner</span>(record_data, record_size);<br>  <span class="hljs-keyword">return</span> RC::SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ—¶è½¬æ¢ä¸º Record æ—¶ï¼Œä¹Ÿéœ€è¦è€ƒè™‘ NULL çš„æƒ…å†µã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">if</span> (value.<span class="hljs-built_in">get_null</span>()) &#123;<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *flag = <span class="hljs-string">&quot;Ã¿Ã¿Ã¿Ã¿&quot;</span>;<br>  <span class="hljs-built_in">memcpy</span>(record_data + field-&gt;<span class="hljs-built_in">offset</span>(), flag, std::<span class="hljs-built_in">min</span>(field-&gt;<span class="hljs-built_in">len</span>(), <span class="hljs-number">4</span>));<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ”¯æŒæ›´æ–°æ•°æ®æ—¶æ›´æ–°-NULLï¼Œå¹¶åˆ¤æ–­åˆæ³•æ€§"><a href="#æ”¯æŒæ›´æ–°æ•°æ®æ—¶æ›´æ–°-NULLï¼Œå¹¶åˆ¤æ–­åˆæ³•æ€§" class="headerlink" title="æ”¯æŒæ›´æ–°æ•°æ®æ—¶æ›´æ–° NULLï¼Œå¹¶åˆ¤æ–­åˆæ³•æ€§"></a>æ”¯æŒæ›´æ–°æ•°æ®æ—¶æ›´æ–° NULLï¼Œå¹¶åˆ¤æ–­åˆæ³•æ€§</h4><p>å’Œæ’å…¥æ•°æ®åŒºåˆ«ä¸å¤§ï¼Œä¹Ÿæ˜¯éœ€è¦é¢å¤–æ·»åŠ ä¸€å±‚åˆ¤æ–­ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// æ£€æŸ¥æ‰€æœ‰æ›´æ–°å­—æ®µæ˜¯å¦å…¨éƒ¨æœ‰æ•ˆ</span><br><span class="hljs-function">RC <span class="hljs-title">Table::update_records</span><span class="hljs-params">(Record &amp;record, std::vector&lt;std::pair&lt;Value, FieldMeta&gt;&gt; update_map_)</span> </span>&#123;<br>  <span class="hljs-comment">// éå†è¡¨æ ¼çš„å…¨éƒ¨åŸŸï¼Œæ‰¾åˆ°ç›®æ ‡åŸŸ</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">int</span> sys_field_num = table_meta_.<span class="hljs-built_in">sys_field_num</span>();<br>  <span class="hljs-type">const</span> <span class="hljs-type">int</span> user_field_num = table_meta_.<span class="hljs-built_in">field_num</span>() - sys_field_num;<br>  FieldMeta *targetFiled = <span class="hljs-literal">nullptr</span>;<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it : update_map_) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; user_field_num; i++) &#123;<br>      <span class="hljs-type">const</span> FieldMeta *field_meta = table_meta_.<span class="hljs-built_in">field</span>(sys_field_num + i);<br>      <span class="hljs-type">const</span> <span class="hljs-type">char</span> *field_name = field_meta-&gt;<span class="hljs-built_in">name</span>();<br><br>      <span class="hljs-comment">// æ‰¾åˆ°ç›®æ ‡åŸŸ</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(field_name, it.second.<span class="hljs-built_in">name</span>()) == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// åˆ¤æ–­ NULL å€¼</span><br>        <span class="hljs-keyword">if</span> (it.first.<span class="hljs-built_in">get_null</span>()) &#123;<br>          <span class="hljs-keyword">if</span> (field_meta-&gt;<span class="hljs-built_in">can_be_null</span>() == <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span> RC::INVALID_ARGUMENT;<br>        &#125;<br>        <span class="hljs-comment">// ç±»å‹åŒ¹é…æ£€æŸ¥</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (field_meta-&gt;<span class="hljs-built_in">type</span>() != it.first.<span class="hljs-built_in">attr_type</span>()) &#123;<br>          Value real_value;<br>          RC rc = Value::<span class="hljs-built_in">cast_to</span>(it.first, field_meta-&gt;<span class="hljs-built_in">type</span>(), real_value);<br>          <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OB_FAIL</span>(rc)) <span class="hljs-keyword">return</span> rc;<br>        &#125;<br><br>        <span class="hljs-comment">// æ‹¿åˆ°ç›®æ ‡åŸŸ</span><br>        targetFiled = (FieldMeta *)field_meta;<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// åŸŸå­˜åœ¨æ£€æŸ¥</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">nullptr</span> == targetFiled) &#123;<br>      <span class="hljs-keyword">return</span> RC::SCHEMA_FIELD_NOT_EXIST;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// æš‚æ—¶å¤‡ä»½æ—§æ•°æ®</span><br>  <span class="hljs-type">char</span> *old_data = record.<span class="hljs-built_in">data</span>();<br>  <span class="hljs-type">char</span> *backup_data = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(record.<span class="hljs-built_in">len</span>());<br>  <span class="hljs-built_in">memcpy</span>(backup_data, old_data, record.<span class="hljs-built_in">len</span>());<br><br>  <span class="hljs-comment">// æ‰€æœ‰å­—æ®µå‡å¯æ›´æ–°ï¼Œå¼€å§‹æ›´æ–°</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it : update_map_) &#123;<br>    RC rc = <span class="hljs-built_in">update_record</span>(record, it.second.<span class="hljs-built_in">name</span>(), &amp;it.first);<br>    <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) <span class="hljs-keyword">return</span> rc;<br>  &#125;<br><br>  <span class="hljs-comment">// å¦‚æœæœ‰ç´¢å¼•ï¼Œæ›´æ–°ç´¢å¼•ï¼Œé¡ºä¾¿æ£€æŸ¥å¦‚æœæ˜¯å”¯ä¸€ç´¢å¼•ï¼Œé‚£ä¹ˆæ˜¯å¦æœ‰é‡å¤</span><br>  std::vector&lt;<span class="hljs-type">const</span> <span class="hljs-type">char</span> *&gt; update_fields;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> &amp;it : update_map_) &#123;<br>    update_fields.<span class="hljs-built_in">push_back</span>(it.second.<span class="hljs-built_in">name</span>());<br>  &#125;<br>  Index *index = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">find_index_by_fields</span>(update_fields);<br>  <span class="hljs-comment">// åªæ£€æŸ¥å¤šç´¢å¼•ï¼Œå•åˆ—ç´¢å¼•äº¤ç»™ update_record å¤„ç†</span><br>  <span class="hljs-keyword">if</span> (index != <span class="hljs-literal">nullptr</span> &amp;&amp; update_fields.<span class="hljs-built_in">size</span>() &gt; <span class="hljs-number">1</span>) &#123;<br>    RC rc = index-&gt;<span class="hljs-built_in">insert_entry</span>(record.<span class="hljs-built_in">data</span>(), &amp;record.<span class="hljs-built_in">rid</span>());<br>    <span class="hljs-keyword">if</span> (rc != RC::SUCCESS &amp;&amp; <span class="hljs-built_in">strcmp</span>(old_data, backup_data) != <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">LOG_ERROR</span>(<span class="hljs-string">&quot;Failed to update data, recovering. table=%s, rc=%d:%s&quot;</span>, <span class="hljs-built_in">name</span>(), rc, <span class="hljs-built_in">strrc</span>(rc));<br>      <span class="hljs-keyword">return</span> rc;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> RC::SUCCESS;<br>&#125;<br><br><span class="hljs-comment">// æ›´æ–°ä¸€ä¸ªå­—æ®µ</span><br><span class="hljs-function">RC <span class="hljs-title">Table::update_record</span><span class="hljs-params">(Record &amp;record, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *attr_name, Value *value)</span> </span>&#123;<br>  <span class="hljs-comment">// éå†è¡¨æ ¼çš„å…¨éƒ¨åŸŸï¼Œæ‰¾åˆ°ç›®æ ‡åŸŸ</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">int</span> sys_field_num = table_meta_.<span class="hljs-built_in">sys_field_num</span>();<br>  <span class="hljs-type">const</span> <span class="hljs-type">int</span> user_field_num = table_meta_.<span class="hljs-built_in">field_num</span>() - sys_field_num;<br>  FieldMeta *targetFiled = <span class="hljs-literal">nullptr</span>;<br><br>  <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span> (; i &lt; user_field_num; i++) &#123;<br>    <span class="hljs-type">const</span> FieldMeta *field_meta = table_meta_.<span class="hljs-built_in">field</span>(sys_field_num + i);<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *field_name = field_meta-&gt;<span class="hljs-built_in">name</span>();<br><br>    <span class="hljs-comment">// æ‰¾åˆ°ç›®æ ‡åŸŸ</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(field_name, attr_name) == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-comment">// åˆ¤æ–­ NULL å€¼</span><br>      <span class="hljs-keyword">if</span> (value-&gt;<span class="hljs-built_in">get_null</span>()) &#123;<br>        <span class="hljs-keyword">if</span> (field_meta-&gt;<span class="hljs-built_in">can_be_null</span>() == <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span> RC::INVALID_ARGUMENT;<br>      &#125;<br>      <span class="hljs-comment">// ç±»å‹åŒ¹é…æ£€æŸ¥</span><br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (field_meta-&gt;<span class="hljs-built_in">type</span>() != value-&gt;<span class="hljs-built_in">attr_type</span>()) &#123;<br>        Value real_value;<br>        RC rc = Value::<span class="hljs-built_in">cast_to</span>(*value, field_meta-&gt;<span class="hljs-built_in">type</span>(), real_value);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">OB_FAIL</span>(rc)) <span class="hljs-keyword">return</span> rc;<br>        *value = std::<span class="hljs-built_in">move</span>(real_value);<br>      &#125;<br><br>      <span class="hljs-comment">// æ‹¿åˆ°ç›®æ ‡åŸŸ</span><br>      targetFiled = (FieldMeta *)field_meta;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// åŸŸå­˜åœ¨æ£€æŸ¥</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-literal">nullptr</span> == targetFiled) &#123;<br>    <span class="hljs-keyword">return</span> RC::SCHEMA_FIELD_NOT_EXIST;<br>  &#125;<br><br>  <span class="hljs-type">int</span> field_offset = targetFiled-&gt;<span class="hljs-built_in">offset</span>();<br>  <span class="hljs-type">int</span> field_length = targetFiled-&gt;<span class="hljs-built_in">len</span>();<br><br>  <span class="hljs-comment">// ä¿®æ”¹æ—§æ•°æ®</span><br>  <span class="hljs-type">char</span> *old_data = record.<span class="hljs-built_in">data</span>();<br><br>  <span class="hljs-comment">// æš‚æ—¶å¤‡ä»½æ—§æ•°æ®</span><br>  <span class="hljs-type">char</span> *backup_data = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(record.<span class="hljs-built_in">len</span>());<br>  <span class="hljs-built_in">memcpy</span>(backup_data, old_data, record.<span class="hljs-built_in">len</span>());<br><br>  <span class="hljs-keyword">if</span> (value-&gt;<span class="hljs-built_in">length</span>() &gt; field_length &amp;&amp; targetFiled-&gt;<span class="hljs-built_in">type</span>() != AttrType::VECTORS) &#123;<br>    <span class="hljs-built_in">memcpy</span>(old_data + field_offset, value-&gt;<span class="hljs-built_in">data</span>(), field_length);<br>  &#125;<br>  ...<br>  <span class="hljs-comment">// å¯¹äº CHARS</span><br>  <span class="hljs-comment">// è¿™ç§ä¸å®šé•¿çš„è®°å½•ï¼Œå¦‚æœæ›´æ–°çš„å…ƒç´ å°äºåŸæ¥çš„é•¿åº¦ï¼Œéœ€è¦é¢å¤–æŠ¹å»åŸæœ‰å…ƒç´ </span><br>  <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">memcpy</span>(old_data + field_offset, value-&gt;<span class="hljs-built_in">data</span>(), value-&gt;<span class="hljs-built_in">length</span>());<br>    <span class="hljs-built_in">memset</span>(old_data + field_offset + value-&gt;<span class="hljs-built_in">length</span>(), <span class="hljs-number">0</span>, field_length - value-&gt;<span class="hljs-built_in">length</span>());<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (value-&gt;<span class="hljs-built_in">get_null</span>()) &#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *flag = <span class="hljs-string">&quot;Ã¿Ã¿Ã¿Ã¿&quot;</span>;<br>    <span class="hljs-built_in">memcpy</span>(old_data + field_offset, flag, std::<span class="hljs-built_in">min</span>(<span class="hljs-number">4</span>, field_length));<br>  &#125;<br><br>  record.<span class="hljs-built_in">set_data</span>(old_data);<br><br>  Index *index = <span class="hljs-keyword">this</span>-&gt;<span class="hljs-built_in">find_index_by_field</span>(targetFiled-&gt;<span class="hljs-built_in">name</span>());<br><br>  <span class="hljs-comment">// å•å­—æ®µç´¢å¼•æ›´æ–°å’Œæ£€æŸ¥</span><br>  <span class="hljs-keyword">if</span> (index != <span class="hljs-literal">nullptr</span>) &#123;<br>    RC rc = index-&gt;<span class="hljs-built_in">insert_entry</span>(record.<span class="hljs-built_in">data</span>(), &amp;record.<span class="hljs-built_in">rid</span>());<br>    <span class="hljs-keyword">if</span> (rc != RC::SUCCESS &amp;&amp; <span class="hljs-built_in">strcmp</span>(old_data, backup_data) != <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">LOG_ERROR</span>(<span class="hljs-string">&quot;Failed to update data, recovering. table=%s, rc=%d:%s&quot;</span>, <span class="hljs-built_in">name</span>(), rc, <span class="hljs-built_in">strrc</span>(rc));<br>      <span class="hljs-keyword">return</span> rc;<br>    &#125;<br>  &#125;<br><br>  record_handler_-&gt;<span class="hljs-built_in">update_record</span>(&amp;record);<br>  <span class="hljs-comment">// delete old_data;</span><br>  <span class="hljs-keyword">return</span> RC::SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ”¯æŒè°“è¯é€»è¾‘æ™®é€šè¿ç®—ç¬¦å¯¹-NULL-è®¡ç®—ï¼Œä»¥åŠè°“è¯é€»è¾‘æ–°å¢è¿ç®—-IS-NULL-and-IS-NOT-NULL"><a href="#æ”¯æŒè°“è¯é€»è¾‘æ™®é€šè¿ç®—ç¬¦å¯¹-NULL-è®¡ç®—ï¼Œä»¥åŠè°“è¯é€»è¾‘æ–°å¢è¿ç®—-IS-NULL-and-IS-NOT-NULL" class="headerlink" title="æ”¯æŒè°“è¯é€»è¾‘æ™®é€šè¿ç®—ç¬¦å¯¹ NULL è®¡ç®—ï¼Œä»¥åŠè°“è¯é€»è¾‘æ–°å¢è¿ç®— IS NULL and IS NOT NULL"></a>æ”¯æŒè°“è¯é€»è¾‘æ™®é€šè¿ç®—ç¬¦å¯¹ NULL è®¡ç®—ï¼Œä»¥åŠè°“è¯é€»è¾‘æ–°å¢è¿ç®— IS NULL and IS NOT NULL</h4><p>ç”±äº Compare éƒ¨åˆ†æˆ‘ä»¬å†™çš„æ¯”è¾ƒå¤æ‚ï¼Œè¿™è¾¹åªå±•ç¤ºæœ‰å…³ IS NULL and IS NOT NULL çš„å‡½æ•°ï¼Œå¯¹äºæ™®é€šè¿ç®—ç¬¦ï¼Œåªéœ€è¦åœ¨æœ€ä¸Šæ–¹åˆ¤æ–­ï¼šå¦‚æœä¸º NULLï¼Œç›´æ¥è¿”å› falseã€‚ä¸è¿‡éœ€è¦æ³¨æ„ï¼Œåé¢æ¶‰åŠåˆ°æ’åºé¢˜ç›®çš„æ—¶å€™ï¼Œä¸èƒ½æ— è„‘è¿”å› falseï¼Œéœ€è¦ç‰¹æ®Šè€ƒè™‘ NULL å’Œ NULL çš„æ¯”è¾ƒã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">IS_NULL_Compare</span><span class="hljs-params">(CompType type_, <span class="hljs-type">const</span> Value &amp;left, <span class="hljs-type">const</span> Value &amp;right, <span class="hljs-type">const</span> std::vector&lt;Value&gt; left_list, <span class="hljs-type">const</span> std::vector&lt;Value&gt; right_list,</span></span><br><span class="hljs-params"><span class="hljs-function">                     <span class="hljs-type">const</span> std::vector&lt;std::vector&lt;Value&gt;&gt; left_tuple_list, <span class="hljs-type">const</span> std::vector&lt;std::vector&lt;Value&gt;&gt; right_tuple_list)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (type_ == CompType::VAL_LIST || type_ == CompType::VAL_VAL || type_ == CompType::VAL_TUPLES) &#123;<br>    <span class="hljs-keyword">return</span> left.<span class="hljs-built_in">get_null</span>();<br>  &#125;<br>  <span class="hljs-keyword">if</span> (!left_list.<span class="hljs-built_in">empty</span>() &amp;&amp; type_ == CompType::LIST_VAL) &#123;<br>    <span class="hljs-keyword">return</span> left_list[<span class="hljs-number">0</span>].<span class="hljs-built_in">get_null</span>();<br>  &#125;<br>  <span class="hljs-keyword">if</span> (!left_tuple_list.<span class="hljs-built_in">empty</span>() &amp;&amp; type_ == CompType::TUPLES_VAL) &#123;<br>    <span class="hljs-keyword">return</span> left_tuple_list[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].<span class="hljs-built_in">get_null</span>();<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="update-select"><a href="#update-select" class="headerlink" title="update-select"></a>update-select</h3><p><img src="/img/update_select.png"></p><p>æœ¬é¢˜è¦æ±‚ update çš„æ›´æ–°ç›®æ ‡å€¼å¯ä»¥é€šè¿‡å­æŸ¥è¯¢å¾—å‡ºï¼Œå­æŸ¥è¯¢ç¬¬ä¸€ç‰ˆæœ¬æ˜¯æˆ‘çš„é˜Ÿå‹å®Œæˆçš„ï¼Œä½†æ˜¯åœ¨å†™å¤æ‚å­æŸ¥è¯¢çš„æ—¶å€™å°†æ•´ä¸ªæ¡†æ¶é‡æ„äº†ä¸€ä¸‹ã€‚å› ä¸ºåœ¨çœ‹ä»£ç æ¡†æ¶çš„æ—¶å€™å‘ç°ï¼Œç”¨äºç”Ÿæˆç®—å­çš„éƒ¨åˆ†æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥å®Œå…¨å¯ä»¥å°†ç”Ÿæˆç®—å­çš„éƒ¨åˆ†æ”¹æˆé™æ€çš„ï¼Œä»è€Œå¯ä»¥ : â€œéšæ—¶éšåœ°ï¼ŒSTNT -&gt; ç®—å­ -&gt; ç»“æœâ€ã€‚è¿™æ ·è®¾è®¡å®Œä¹‹åï¼Œæƒ³è¦è·å–å­æŸ¥è¯¢çš„ç»“æœåªéœ€è¦ä¸€ä¸ª STMTï¼Œæå¤§çš„ç®€åŒ–äº†ä»£ç ï¼Œç”šè‡³ update-select å¹¶æ²¡æœ‰æ–°å¢ä»€ä¹ˆå†…å®¹ï¼Œåªæ˜¯åœ¨æ”¶é›†æ›´æ–°çš„ Value æ—¶ï¼Œå¤šå¢ä¸€æ­¥ï¼Œå¦‚æœ Value æ˜¯å­æŸ¥è¯¢éœ€è¦è½¬åŒ–ä¸€ä¸‹ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‡†ç¡®è¯´å½“æ—¶å› ä¸ºè¿™ä¸ª debug äº†å¥½ä¹…ï¼Œwhere å­å¥ç­›é€‰å‡ºæ¥çš„å…ƒç»„é›†åˆä¸ºç©ºé›†æ—¶ï¼Œå³ä¾¿å­æŸ¥è¯¢æœå‡ºæ¥çš„ç»“æœä¸åˆæ³•ï¼Œä¹Ÿç®— SUCCESSã€‚<br>å¯¹äºå­æŸ¥è¯¢ï¼Œèƒ½å½“ä½œ update çš„ Value çš„å……åˆ†å¿…è¦æ¡ä»¶æ˜¯æœå‡ºæ¥çš„å…ƒç»„æ•°ç»„ï¼Œæˆ–è€…äºŒç»´æ•°ç»„ï¼Œåªèƒ½æ˜¯ä¸€ä¸ªå…ƒç´ ã€‚å¦‚æœæœå‡ºæ¥æ˜¯ç©ºé›†ï¼Œç­‰åŒäºæ’å…¥ NULLã€‚</p><h4 id="STMT-vector-vector-Value"><a href="#STMT-vector-vector-Value" class="headerlink" title="STMT -&gt; vector&lt; vector&lt; Value&gt;&gt;"></a>STMT -&gt; vector&lt; vector&lt; Value&gt;&gt;</h4><p>æ›´è¿‘ä¸€æ­¥ï¼Œè®¾è®¡ä¸€ä¸ªå‡½æ•°ï¼Œè¾“å…¥ STMTï¼Œè¾“å‡ºä¸ºäºŒç»´ Value æ•°ç»„ï¼Œçœå»ä¸­é—´çš„éƒ¨åˆ†ã€‚å‡½æ•°è®¾è®¡å¦‚ä¸‹ï¼šè¾“å…¥ STMTï¼Œè¾“å‡º æ•°æ® + è¡¨å¤´ä¿¡æ¯ã€‚å…¶ä¸­ main_tuple ä¸ºå¤æ‚å­æŸ¥è¯¢çš„å†…å®¹ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">RC <span class="hljs-title">OptimizeStage::handle_sub_stmt</span><span class="hljs-params">(Stmt *stmt, std::vector&lt;std::vector&lt;Value&gt;&gt; &amp;tuple_list, TupleSchema &amp;tuple_schema, <span class="hljs-type">const</span> Tuple *main_tuple)</span> </span>&#123;<br>  SelectStmt *select_stmt = <span class="hljs-built_in">static_cast</span>&lt;SelectStmt *&gt;(stmt);<br>  vector&lt;Table *&gt; tables = select_stmt-&gt;<span class="hljs-built_in">tables</span>();<br>  string table_names;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it : tables) table_names += it-&gt;<span class="hljs-built_in">name</span>();<br><br>  RC rc = RC::SUCCESS;<br><br>  <span class="hljs-comment">// ? ä¸å­˜åœ¨åˆ›å»ºå¥½çš„é€»è¾‘ç®—å­</span><br>  <span class="hljs-keyword">if</span> (!sub_expr_and_logical_oper.<span class="hljs-built_in">contains</span>(table_names)) &#123;<br>    unique_ptr&lt;LogicalOperator&gt; logical_oper;<br>    rc = <span class="hljs-built_in">create_logical_plan</span>(stmt, logical_oper);<br><br>    <span class="hljs-keyword">if</span> (rc != RC::SUCCESS &amp;&amp; rc != RC::UNIMPLEMENTED) <span class="hljs-keyword">return</span> rc;<br>    <span class="hljs-built_in">ASSERT</span>(logical_oper, <span class="hljs-string">&quot;logical operator is null&quot;</span>);<br><br>    sub_expr_and_logical_oper.<span class="hljs-built_in">insert</span>(<span class="hljs-built_in">make_pair</span>(table_names, std::<span class="hljs-built_in">move</span>(logical_oper)));<br>  &#125;<br><br>  <span class="hljs-comment">// ? ä¸å­˜åœ¨åˆ›å»ºå¥½çš„ç‰©ç†ç®—å­</span><br>  <span class="hljs-keyword">if</span> (!sub_expr_and_physical_oper.<span class="hljs-built_in">contains</span>(table_names)) &#123;<br>    unique_ptr&lt;PhysicalOperator&gt; physical_oper;<br>    rc = <span class="hljs-built_in">generate_physical_plan</span>(sub_expr_and_logical_oper[table_names], physical_oper);<br><br>    <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) <span class="hljs-keyword">return</span> rc;<br><br>    sub_expr_and_physical_oper.<span class="hljs-built_in">insert</span>(<span class="hljs-built_in">make_pair</span>(table_names, std::<span class="hljs-built_in">move</span>(physical_oper)));<br>  &#125;<br><br>  PhysicalOperator *physical_oper = sub_expr_and_physical_oper[table_names].<span class="hljs-built_in">get</span>();<br>  rc = <span class="hljs-built_in">get_tuple_schema</span>(physical_oper, tuple_schema);<br>  <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) <span class="hljs-keyword">return</span> rc;<br><br>  rc = <span class="hljs-built_in">get_tuple_list</span>(physical_oper, tuple_list, main_tuple);<br>  <span class="hljs-keyword">return</span> rc;<br>&#125;<br><br><span class="hljs-function">RC <span class="hljs-title">OptimizeStage::create_logical_plan</span><span class="hljs-params">(Stmt *stmt, unique_ptr&lt;LogicalOperator&gt; &amp;logical_operator)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-literal">nullptr</span> == stmt) &#123;<br>    <span class="hljs-keyword">return</span> RC::UNIMPLEMENTED;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> LogicalPlanGenerator::<span class="hljs-built_in">create</span>(stmt, logical_operator);<br>&#125;<br><br><span class="hljs-function">RC <span class="hljs-title">OptimizeStage::generate_physical_plan</span><span class="hljs-params">(unique_ptr&lt;LogicalOperator&gt; &amp;logical_operator, unique_ptr&lt;PhysicalOperator&gt; &amp;physical_operator)</span> </span>&#123;<br>  RC rc = PhysicalPlanGenerator::<span class="hljs-built_in">create</span>(*logical_operator, physical_operator);<br><br>  <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) &#123;<br>    <span class="hljs-built_in">LOG_WARN</span>(<span class="hljs-string">&quot;failed to create physical operator. rc=%s&quot;</span>, <span class="hljs-built_in">strrc</span>(rc));<br>  &#125;<br>  <span class="hljs-keyword">return</span> rc;<br>&#125;<br><br><span class="hljs-function">RC <span class="hljs-title">OptimizeStage::get_tuple_schema</span><span class="hljs-params">(PhysicalOperator *physical_operator, TupleSchema &amp;tuple_schema)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> physical_operator-&gt;<span class="hljs-built_in">tuple_schema</span>(tuple_schema);<br>&#125;<br><br><span class="hljs-function">RC <span class="hljs-title">OptimizeStage::get_tuple_list</span><span class="hljs-params">(PhysicalOperator *physical_operator, std::vector&lt;std::vector&lt;Value&gt;&gt; &amp;tuple_list, <span class="hljs-type">const</span> Tuple *main_tuple)</span> </span>&#123;<br>  RC rc = physical_operator-&gt;<span class="hljs-built_in">open</span>(<span class="hljs-literal">nullptr</span>, main_tuple);<br>  <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) &#123;<br>    <span class="hljs-built_in">LOG_WARN</span>(<span class="hljs-string">&quot;failed to open sub physical operator. rc=%s&quot;</span>, <span class="hljs-built_in">strrc</span>(rc));<br>    <span class="hljs-keyword">return</span> rc;<br>  &#125;<br><br>  <span class="hljs-comment">// å°†æŸ¥è¡¨ç»“æœæ”¾å…¥value_list</span><br>  <span class="hljs-keyword">while</span> (RC::SUCCESS == (rc = physical_operator-&gt;<span class="hljs-built_in">next</span>(main_tuple))) &#123;<br>    Tuple *tuple = physical_operator-&gt;<span class="hljs-built_in">current_tuple</span>();<br>    std::vector&lt;Value&gt; single_tuple;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; tuple-&gt;<span class="hljs-built_in">cell_num</span>(); i++) &#123;<br>      Value value;<br>      tuple-&gt;<span class="hljs-built_in">cell_at</span>(i, value);<br>      single_tuple.<span class="hljs-built_in">push_back</span>(value);<br>    &#125;<br>    tuple_list.<span class="hljs-built_in">push_back</span>(single_tuple);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (rc != RC::RECORD_EOF) <span class="hljs-keyword">return</span> rc;<br><br>  rc = physical_operator-&gt;<span class="hljs-built_in">close</span>();<br>  <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) <span class="hljs-keyword">return</span> rc;<br><br>  <span class="hljs-keyword">return</span> RC::SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="update-ä¸­æ·»åŠ æœ‰å…³å­æŸ¥è¯¢çš„éƒ¨åˆ†"><a href="#update-ä¸­æ·»åŠ æœ‰å…³å­æŸ¥è¯¢çš„éƒ¨åˆ†" class="headerlink" title="update ä¸­æ·»åŠ æœ‰å…³å­æŸ¥è¯¢çš„éƒ¨åˆ†"></a>update ä¸­æ·»åŠ æœ‰å…³å­æŸ¥è¯¢çš„éƒ¨åˆ†</h4><p>å¦‚æœå‘ç°æœ‰å­æŸ¥è¯¢ï¼Œé€šè¿‡å‡½æ•°å°†å…¶è½¬åŒ–ä¸ºäºŒç»´ Value æ•°ç»„ï¼Œå¦‚æœæ•°ç»„åªæœ‰ä¸€ä¸ªå…ƒç´ åˆ™åˆæ³•ï¼Œæ‹¿å‡ºæ¥ï¼›å¦‚æœæ•°ç»„ä¸ºç©ºï¼Œåˆ™ç­‰åŒäº NULLï¼›å¦‚æœæ•°ç»„ä¸ä¸ºç©ºï¼Œç­‰åŒä¸€ä¸ªéæ³•çš„ Valueï¼Œæ³¨æ„è¿™é‡Œå¹¶æ²¡æœ‰ç›´æ¥è¿”å› FAILUREï¼Œå› ä¸ºå¦‚æœ where å­å¥ç­›é€‰é›†ä¸ºç©ºé›†ï¼Œå³ä¾¿å­æŸ¥è¯¢æœ‰è¯¯ä¹Ÿè¿”å› SUCCESSï¼Œæ‰€ä»¥è¿™é‡Œé€šè¿‡ç‰¹æ„æ„é€ éæ³• Valueï¼Œå¦‚æœ where å­å¥ç­›é€‰é›†ä¸ä¸ºç©ºé›†ï¼Œåˆ™ä¼šè¯†åˆ«éæ³• Value å¹¶è¿”å› FAILUREï¼›å¦‚æœ where å­å¥ç­›é€‰é›†ä¸ºç©ºé›†ï¼Œåˆ™ä¸ä¼šæœ‰è¯†åˆ«ç¯èŠ‚ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">RC <span class="hljs-title">UpdateStmt::create</span><span class="hljs-params">(Db *db, UpdateSqlNode &amp;update, Stmt *&amp;stmt)</span> </span>&#123;<br>  <span class="hljs-comment">// æ‹¿åˆ°ç›®æ ‡è¡¨æ ¼ä»¥åŠåç§°ä»¥åŠä¿®æ”¹åŸŸ</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *table_name = update.relation_name.<span class="hljs-built_in">c_str</span>();<br>  Table *table = db-&gt;<span class="hljs-built_in">find_table</span>(table_name);<br><br>  <span class="hljs-comment">// ç›®æ ‡è¡¨æ ¼ä¸å­˜åœ¨æ£€æŸ¥</span><br>  <span class="hljs-keyword">if</span> (table == <span class="hljs-literal">nullptr</span>) &#123;<br>    <span class="hljs-built_in">LOG_WARN</span>(<span class="hljs-string">&quot;no such table. db=%s, table_name=%s&quot;</span>, db-&gt;<span class="hljs-built_in">name</span>(), table_name);<br>    <span class="hljs-keyword">return</span> RC::SCHEMA_TABLE_NOT_EXIST;<br>  &#125;<br>  <span class="hljs-comment">// å‚æ•°éæ³•æ£€æŸ¥</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-literal">nullptr</span> == db || <span class="hljs-literal">nullptr</span> == table_name) &#123;<br>    <span class="hljs-built_in">LOG_WARN</span>(<span class="hljs-string">&quot;invalid argument. db=%p, table_name=%p&quot;</span>, db, table_name);<br>    <span class="hljs-keyword">return</span> RC::INVALID_ARGUMENT;<br>  &#125;<br><br>  <span class="hljs-comment">// æ‹¿åˆ°å…¨éƒ¨ä¿®æ”¹åŸŸ</span><br>  std::vector&lt;FieldMeta&gt; field_metas;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it : update.update_targets) &#123;<br>    FieldMeta *field_meta = (FieldMeta *)table-&gt;<span class="hljs-built_in">table_meta</span>().<span class="hljs-built_in">field</span>(it.attribute_name.<span class="hljs-built_in">c_str</span>());<br>    <span class="hljs-comment">// ä¿®æ”¹åŸŸæ£€æŸ¥</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">nullptr</span> == field_meta) &#123;<br>      <span class="hljs-keyword">return</span> RC::SCHEMA_FIELD_NOT_EXIST;<br>    &#125;<br>    field_metas.<span class="hljs-built_in">push_back</span>(*field_meta);<br>  &#125;<br><br>  <span class="hljs-comment">// åˆ›å»ºç­›é€‰ STMT å¯¹è±¡</span><br>  std::unordered_map&lt;std::string, Table *&gt; table_map;<br>  table_map.<span class="hljs-built_in">insert</span>(std::<span class="hljs-built_in">pair</span>&lt;std::string, Table *&gt;(std::<span class="hljs-built_in">string</span>(table_name), table));<br>  FilterStmt *filter_stmt = <span class="hljs-literal">nullptr</span>;<br>  <span class="hljs-type">bool</span> flag;<br>  RC rc = FilterStmt::<span class="hljs-built_in">create</span>(db, table, &amp;table_map, update.conditions.<span class="hljs-built_in">data</span>(), <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(update.conditions.<span class="hljs-built_in">size</span>()), filter_stmt, flag);<br><br>  <span class="hljs-comment">// è°“è¯è¯­å¥åˆæ³•æ£€æŸ¥</span><br>  <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) &#123;<br>    <span class="hljs-built_in">LOG_WARN</span>(<span class="hljs-string">&quot;failed to create filter statement. rc=%d:%s&quot;</span>, rc, <span class="hljs-built_in">strrc</span>(rc));<br>    <span class="hljs-keyword">return</span> rc;<br>  &#125;<br><br>  <span class="hljs-comment">// åˆ›å»ºå­æŸ¥è¯¢çš„ STMT å¯¹è±¡</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (<span class="hljs-type">int</span>)update.update_targets.<span class="hljs-built_in">size</span>(); i++) &#123;<br>    <span class="hljs-keyword">if</span> (update.update_targets[i].is_value == <span class="hljs-literal">false</span>) &#123;<br>      Stmt *temp;<br>      rc = SelectStmt::<span class="hljs-built_in">create</span>(db, update.update_targets[i].sub_select-&gt;selection, temp, flag);<br>      <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) <span class="hljs-keyword">return</span> rc;<br>      vector&lt;vector&lt;Value&gt;&gt; tuple_list;<br>      TupleSchema tuple_schema;<br>      OptimizeStage::<span class="hljs-built_in">reset</span>();<br>      RC rc = OptimizeStage::<span class="hljs-built_in">handle_sub_stmt</span>(temp, tuple_list, tuple_schema);<br>      <span class="hljs-keyword">if</span> (rc != RC::SUCCESS) <span class="hljs-keyword">return</span> RC::INVALID_ARGUMENT;<br>      <span class="hljs-comment">// å­æŸ¥è¯¢ä¸ºç©ºå€¼ï¼Œç­‰åŒäºæ’å…¥ NULL</span><br>      <span class="hljs-keyword">if</span> (tuple_list.<span class="hljs-built_in">empty</span>()) &#123;<br>        update.update_targets[i].value.<span class="hljs-built_in">set_null</span>(<span class="hljs-literal">true</span>);<br>      &#125;<br>      <span class="hljs-comment">// å­æŸ¥è¯¢éæ³•ï¼Œç­‰åŒäºæ’å…¥éæ³• Valueï¼Œå¦‚æœç­›é€‰å‡ºæ¥æ²¡æœ‰æ›´æ–°ç›®æ ‡ï¼Œåˆ™æ— è§†ï¼Œå¦åˆ™æŠ¥é”™</span><br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tuple_list.<span class="hljs-built_in">size</span>() != <span class="hljs-number">1</span> || tuple_list[<span class="hljs-number">0</span>].<span class="hljs-built_in">size</span>() != <span class="hljs-number">1</span>) &#123;<br>        update.update_targets[i].value.<span class="hljs-built_in">set_type</span>(AttrType::UNDEFINED);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        update.update_targets[i].value = tuple_list[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>];<br>      &#125;<br>      update.update_targets[i].is_value = <span class="hljs-literal">true</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// check date validity</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it : update.update_targets) &#123;<br>    Value value = it.value;<br>    <span class="hljs-keyword">if</span> (value.<span class="hljs-built_in">attr_type</span>() == AttrType::DATE) &#123;<br>      <span class="hljs-keyword">if</span> (!DateType::<span class="hljs-built_in">check_date</span>(value.<span class="hljs-built_in">get_date</span>())) &#123;<br>        <span class="hljs-keyword">return</span> RC::INVALID_ARGUMENT;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value.<span class="hljs-built_in">attr_type</span>() == AttrType::CHARS) &#123;<br>      <span class="hljs-keyword">if</span> (value.<span class="hljs-built_in">get_string</span>().<span class="hljs-built_in">size</span>() &gt; BP_MAX_TEXT_SIZE) &#123;<br>        <span class="hljs-keyword">return</span> RC::INVALID_ARGUMENT;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value.<span class="hljs-built_in">attr_type</span>() == AttrType::VECTORS) &#123;<br>      <span class="hljs-keyword">if</span> (value.<span class="hljs-built_in">get_vector_size</span>() &gt; BP_MAX_VECTOR_SIZE) &#123;<br>        <span class="hljs-keyword">return</span> RC::INVALID_ARGUMENT;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// åˆ›å»º update çš„ STMT å¯¹è±¡</span><br>  stmt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">UpdateStmt</span>(table, filter_stmt, field_metas, update.update_targets);<br>  <span class="hljs-keyword">return</span> RC::SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="alias"><a href="#alias" class="headerlink" title="alias"></a>alias</h3><p><img src="/img/alias.png"></p><h3 id="order-by"><a href="#order-by" class="headerlink" title="order-by"></a>order-by</h3><p><img src="/img/order_by.png"></p><h3 id="aggregation-and-groupby"><a href="#aggregation-and-groupby" class="headerlink" title="aggregation_and_groupby"></a>aggregation_and_groupby</h3><p><img src="/img/aggregation_and_groupby.png"></p><h3 id="create-table-select"><a href="#create-table-select" class="headerlink" title="create-table-select"></a>create-table-select</h3><p><img src="/img/create_table_select.png"></p><h3 id="vector-rewrite"><a href="#vector-rewrite" class="headerlink" title="vector_rewrite"></a>vector_rewrite</h3><p><img src="/img/vector_rewrite.png"></p><h3 id="vector-search"><a href="#vector-search" class="headerlink" title="vector_search"></a>vector_search</h3><p><img src="/img/vector_search.png"></p><h3 id="complex-sub-query"><a href="#complex-sub-query" class="headerlink" title="complex-sub-query"></a>complex-sub-query</h3><p><img src="/img/complex_sub_query.png"></p>]]></content>
    
    
    
    <tags>
      
      <tag>Competition</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
